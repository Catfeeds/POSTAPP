<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>收银台</title>
<meta name="format-detection" content="telephone=no, address=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-touch-fullscreen" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link href="{MODULE_URL}image/css/bootstrap.min.css" rel="stylesheet">
<link href="{MODULE_URL}image/css/font-awesome.min.css" rel="stylesheet">
<link href="{MODULE_URL}image/css/common.css" rel="stylesheet">
<script src="{MODULE_URL}template/js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" charset="utf-8" src="{MODULE_URL}image/js/lib/bootstrap.min.js"></script>
<script src="{MODULE_URL}template/js/sweetalert.min2.js"></script>
<link type="text/css" rel="stylesheet" href="{MODULE_URL}template/js/sweetalert.css"/>
<script src="{MODULE_URL}template/js/jquery.transit.js"></script>
<script src="{MODULE_URL}template/js/radialIndicator.min.js"></script>
<script src="{MODULE_URL}template/mobile/default/jetsum_j_money_order.js"></script>
<script src="{MODULE_URL}template/js/JKeyboard.js"></script>
<script src="{MODULE_URL}template/js/jquery.cookie.js"></script>
<link type="text/css" rel="stylesheet" href="{MODULE_URL}template/js/JKeyboard.css"/>
<script src="{MODULE_URL}template/js/jquery.nicescroll.min.js"></script>

<script src="{MODULE_URL}template/js/jedate/jedate.min.js"></script>
</head>
<body>
{if $operation=='display'}
<style>
html{ height:100%;}
body{height:100%; overflow:hidden; background:url({php echo $shop['bg'] ? tomedia($shop['bg']): tomedia($cfg['bg'])}); background-size:100% 100%;}
.login_body{display:table; width:80%; margin:0 auto; text-align:center}
.jrow{ display:table-row;}
.jcell{ display:table-cell; width:100%;vertical-align:middle; text-align:center; height:100%; text-align:center;}
.logo{ margin-bottom:40px;}
.logo img{ height:100%}
.font24{ font-size:24px;color:#FFF}
.btns{ display:inline-block;width:210px; margin-top:20px}
.progress{ width:200px; margin:0 auto; opacity:0;}
.keyboardbtn{ position:absolute; z-index:33; border:1px solid #CCC; box-shadow:0px 0px 2px #FFF; padding:10px; border-radius:8px;right:20px; bottom:20px;background:#FFF; color:#09F;}
.keyboardon{color:#FFF; background:#09F;}
</style>
<!--登录-->
<form>
<div class="login_body">
  <div class="jcell">
    <div class="logo"><img src="{php echo tomedia($_GPC['cookie_logo'])}" onerror="this.style.display='none'"/></div>
    <div class="form-inline">
      <div class="input-group" id="box_user"> <span class="input-group-addon"><i class="fa fa-user"></i></span>
        <input type="text" class="form-control" name="username" />
      </div>
      <span class="font24">&middot;</span><span class="font24">&middot;</span><span class="font24">&middot;</span> <img src="{php echo tomedia($_GPC['cookie_headimg'])}" onerror="this.src='{MODULE_URL}template/img/head.jpg'" style="vertical-align:middle" class="img-circle img-thumbnail logohead"/> <span class="font24">&middot;</span><span class="font24">&middot;</span><span class="font24">&middot;</span>
      <div class="input-group" id="box_pass">
        <input type="password" class="form-control" name="pwds" />
        <span class="input-group-addon"><i class="fa fa-key"></i></span> </div>
    </div>
    <div class="submitbtn">
      <button type="submit" class="btn btn-primary btns" onClick="return checkUpdate();" ><i class="fa fa-unlock"></i> 登陆</button>
    </div>
    <div class="progress">
      <div class="progress-bar progress-bar-striped active" role="progressbar"> <span class="sr-only"></span> </div>
    </div>
  </div>
</div>
</form>
<div class="keyboardbtn"><i class="fa fa-keyboard-o fa-2x"></i></div>
<script language="javascript">
$(document).ready(function(e) {
    var _h=$(document).height();
	$(".jcell").height(_h);
});
$(".keyboardbtn").on('click',function(){
	if($(this).hasClass('keyboardon')){
		$(this).removeClass('keyboardon');
		$('input[name="username"]').unbind('click');
		$('input[name="pwds"]').unbind('click');
		$(this).JKeyboard({'show':false})
	}else{
		$(this).addClass('keyboardon');
		$('input[name="username"]').bind('click',function(){
			$('input[name="username"]').JKeyboard({'type':1,'val':'','tips':'请输入账号'});
		})
		$('input[name="pwds"]').bind('click',function(){
			$('input[name="pwds"]').JKeyboard({'type':1,'val':'','tips':'请输入密码'});
		})
	}
})

function checkUpdate(){
	var userid=$("input[name='username']").val();
	var pwd=$("input[name='pwds']").val();
	if(userid.length<1){
		swal("用户名不能为空");
		return false;
	}
	if(pwd.length<6){
		swal("密码长度不正确");
		return false;
	}
	jetsumpay.logIn({
		"uniacid":"{$_W[uniacid]}","siteroot":"{$_W[siteroot]}","userid":userid,"pwd":pwd,
		"success":function(result){
			$("#box_user").transition({ x:30,opacity:0 });
			$("#box_pass").transition({ x:-30,opacity:0 });
			$(".btns").transition({opacity:0});
			$(".logohead").transition({ y:-20,});
			$(".progress").transition({opacity:1,y:-50}, function(){
			  $(".progress-bar").transition({width:'100%'}, function(){
				  location.href="{php echo $this->createMobileUrl('index',array('op'=>'in'))}";
			  });
			});
			
		},
		"falsed":function(result){
			swal(result);
		}
	});
	return false;
}
</script> 
{else}
<!--登录成功-->
<style>
ul,ul li,li{list-style:none; padding:0; margin:0;}
html{ height:100%;}
body{height:100%; background:#F1F1F1;color:#333}
.jtable{ display:table; width:100%;}
.jrow{ display:table-row;}
.jcell{ display:table-cell;}
.red{color:#F00}
.hiden{ display:none;}
.labelBtn{display:inline-block;position:relative; cursor:pointer; text-align:center;}
.labelBtn .label{ font-size:60%; position:absolute; z-index:2; right:0; top:3px; font-weight:normal}
.body_top{line-height:50px; height:50px; background:#18BC9C; overflow:hidden;}
.body_top_logo{ display:inline-block; width:226px; text-align:center; background:#1B2428;}
.body_top_logo img{ max-width:210px; max-height:46px;}
.body_top_menu{display:inline-block; line-height:50px; padding:0 15px; background:#303641;color:#FFF;}
.body_top_btn{line-height:30px;padding:10px 15px 0 15px;color:#FFF;}
.body_top_btn2{line-height:18px;padding:5px 15px 0 15px;color:#FFF;}
.body_top_btn2 p{color:#FFF; margin:0;}
.body_top_user{ color:#FFF; margin:-1px 20px 0 20px; display:inline-block;}
.body_top_logout{display:inline-block; line-height:49px; text-align:center; width:49px; background:#232B2D;color:#18BC9C; font-size:20px; margin-top:-1px; cursor:pointer;}
.body_main{display:table; width:100%;}
.body_mainLeft{ width:80px; vertical-align:top; background:#1B2428; height:80%;color:#FFF; overflow:hidden;}

ul.left_btngroup li{text-align:center; padding:10px 5px;color:#80969C;border-left:3px solid #1B2428; border-bottom:#000;color:#80969C; cursor:pointer;}
ul.left_btngroup li i{color:#80969C;}
ul.left_btngroup li div{}
ul.left_btngroup li:hover{background:#23BAB5; color:#FFF;border-left:3px solid #23BAB5;}
ul.left_btngroup li:hover i{color:#FFF}
ul.left_btngroup li.active{ border-left:3px solid #23BAB5; color:#FFF;}
ul.left_btngroup li.active i{color:#FFF}
.body_mainRight{vertical-align:top; padding:10px;}
._bm_color1{border-bottom:1px solid #6CADD1}
._bm_color2{border-bottom:1px solid #DF6C6E}
._bm_color3{border-bottom:1px solid #eac841}
._bm_color4{border-bottom:1px solid #A0D269}
._bm_color5{border-bottom:1px solid #23BAB5}
.main_window{ display:table; width:100%;}
.mainW_memuleft{ display:table-cell; vertical-align:top; width:350px; border-radius:4px; background:#DDD; padding:5px}
.mune_box{ background:#FFF; padding:3px; }
.mune_box ul{border:1px solid #CCC;border-bottom:none;overflow:hidden; position:relative;}
.mune_box ul li{display:table;width:100%}
.mune_box ul li .jcell{ display:table-cell; padding:5px;border-bottom:1px solid #CCC; vertical-align:middle; height:48px}
.mune_box ul li .jcell:nth-child(1){}
.mune_box ul li .jcell:nth-child(2){border-right:1px solid #CCC;border-left:1px solid #CCC; text-align:center;width:52px; font-family:Arial}
.mune_box ul li .jcell:last-child{text-align:right; width:86px}
.mune-sum{ padding:5px; border:1px solid #CCC; font-size:16px;}
.mune-searchbox{ margin-bottom:5px;}
.mainW_memuright{ display:table-cell; vertical-align:top; padding-left:10px;font-family:Arial;}
.select-item{ background:#FFF; border-radius:4px; border:1px solid #CCC; padding:10px; border-top-right-radius:0}
.select-box{ position:relative; width:100%; text-align:left; overflow:hidden;}
.select-box ul{position:absolute; width:100%;}
.select-box ul li{display:inline-block; width:23.3%;border:1px solid #CCC;margin:5px 0.5% 0 0; position:relative;border-radius:4px; height:140px;box-shadow:0 0 5px #CCC;}
.select-box ul li div{position:absolute; bottom:0; width:100%;}
.select-box ul li div span{ display:block; text-align:center; font-size:12px; line-height:16px;color:#FFF;background:rgba(0,0,0,0.5);}
.select-box ul li div h3{text-align:left; margin:0; padding:5px; background:#666;color:#FFF; font-size:12px; border-bottom-left-radius:4px;border-bottom-right-radius:4px; width:100%; overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.select-box-btn{ margin:10px auto;}
.select-class{ width:60px; vertical-align:top; font-size:12px;}
.select-class ul li{ text-align:center;border-top-right-radius:4px;border-bottom-right-radius:4px; background:#FFF;border:1px solid #CCC; border-left:none; padding:10px 5px ; margin-bottom:1px; cursor:pointer;}
ul#coupon_list li{color:#999; padding:5px 0;}
ul#coupon_list li b{color:#999;}
ul#coupon_list li.active{color:#489AFE;font-weight:bold}
ul#coupon_list li.active b{color:#489AFE;}
.select-class ul .active{ background:#6CADD1; color:#FFF; border-color:#6CADD1}
.num{ font-size:20px; color:#DF6C6E}
.price{ font-size:20px; color:#DF6C6E}
.left_menubtn { padding:10px 0 0 0 ;}
.left_menubtn .btn{ line-height:40px; font-size:16px;}
.right_menubtn .btn{line-height:40px; font-size:16px;}
/**/
.sweet-counter-box{ text-align:left;}
.sweet-counter-box ul { position:relative;}
.sweet-counter-box ul li{display:inline-block;width:24.3%; margin:2px 0.2%; text-align:center; line-height:40px; border:1px solid #CCC; border-radius:4px; font-size:18px; cursor:pointer;}
.sweet-counter-box .sweet-counter-c{position:absolute; z-index:2; height:134px;padding-top:46px}
.sweet-counter-box .sweet-counter-0{width:48.8%}
.sweet-counter-box ul li:hover,.sweet-counter-box ul li:active{ background:#CCC;}
.historybox{ width:100%; min-width:100%;}
.historybox td{padding:6px;}
.historybox th{padding:0 6px; font-weight:bolder;}
.line-box{border:1px solid #6CADD1; margin:5px 0; border-radius:4px;}
.line-box h2{ border-top-left-radius:4px;border-top-right-radius:4px; text-align:left; font-size:14px; border-bottom:1px solid #6CADD1;padding:10px; margin:0;}
.line-box div{padding:10px;color:#23BAB5}
.red2{color:#DF6C6E;}
.pay_box div{ font-size:14px;}
.select-pay .jcell{ vertical-align:top;}
.masker{width:100%;background:rgba(0,0,0,0.5);position:absolute; z-index:3; left:0; top:0;}
#top_menu{position:absolute;z-index:4; background:#FFF; box-shadow:0px 0px 5px #FFF;border-radius:4px;min-width:420px;}
#top_menu a{display:block;text-align:center;height:100px;line-height:100px;color:#333}
#top_menu a:hover{ text-decoration:none; background:#E7E7E7}
#top_menu a div{line-height:24px;padding-top:25px;}
#top_menu a div p{ margin:0;}
.gooddealmark{ width:100%;background:rgba(0,0,0,0.3);position:absolute; z-index:3000; left:0; top:0}
#gooddeal{height:50px; position:absolute; z-index:3001; padding:6px 0 0 10px;}
#gooddeal input{ display:inline-block; width:60px; text-align:center;}
.mlr10{ margin:0 20px;}
.mlr2{ margin:0 10px;}
.pay_boxshow .jcell:first-child{box-shadow:0px 0px 2px #CCC; border-radius:4px; background:#FFF; font-size:14px; line-height:26px}
.pay_boxshow .jcell:last-child{box-shadow:0px 0px 2px #CCC; border-radius:4px; background:#FFF; font-size:14px;line-height:26px}
.jpanel{ box-shadow:0px 0px 2px #CCC; border-radius:4px; background:#FFF; font-size:12px;}
.jpanel .jpanel-head{ border-bottom:1px solid #DDD;padding:5px 10px;border-top-left-radius:4px;border-top-right-radius:4px;}
.jpanel .jpanel-body{padding:10px;}
.f12{ font-size:12px;}
.f20{ font-size:20px; line-height:20px}
.paybtnGroup div{ margin-bottom:10px;}
.paybtnGroup .btn{line-height:40px; font-size:12px; font-weight:bold}
.paybtnGroup .btn-half{ width:48%; }
.paybtnGroup ul{margin-bottom:10px; position:relative;}
.paybtnGroup ul li{display:inline-block; width:24%; margin-right:0.3%; text-align:center; line-height:52px;font-size:18px; font-weight:bold; border:1px solid #DDD; background:#FFF; border-radius:4px;}
.paybtnGroup ul li:last-child{ margin:0}
.paybtnGroup ul li.btn_sure{ position:absolute; z-index:2;width:24%; margin-left:4px; line-height:116px; background:#5cb85c;color:#FFF;}
.paybtnGroup .input-group{ margin:0;}
.paybtnGroup .input-group span{line-height:38px;height:38px;font-size:14px;}
.paybtnGroup .input-group input{line-height:52px;height:52px;font-size:26px; text-align:right}
.payNumbtn li{ cursor:pointer;}
.payNumbtn li:active{ background:#900;color:#FFF;}
/**/
ul.radio li{ display:inline-block; padding:5px 0; width:74px; text-align:center; margin:0 10px 10px 0;border:1px solid #CCC; border-radius:4px; cursor:pointer}
ul.radio li i{ font-size:30px;}
ul.radio li.checked{ border-color:#ffc107; background:#ffc107; color:#FFF;}

/**/
</style>
<div class="body_top">
  <div class="body_top_logo"><img src="{php echo tomedia($shop['logo'])}" onerror="this.style.display='none'"/></div><div class="body_top_menu" onClick="top_menu();"><i class="fa fa-th"></i> 主菜单</div>
  
  <span class="pull-right">
  <div class="body_top_btn labelBtn" onClick="testPrint()"><i class="fa fa-print fa-2x"></i></div>
  <!--<div class="body_top_btn labelBtn"><i class="fa fa-envelope fa-2x"></i><span class="label label-danger">0</span></div>-->
  <div class="body_top_user">{$user['realname']} <img src="{php echo tomedia($user['headimg'])}" onerror="this.src='{MODULE_URL}template/img/head.jpg'" width="36" class="img-circle img-thumbnail"/> <i class="fa fa-angle-down"></i></div>
  <div class="body_top_logout" onClick="exchange();"><i class="fa fa-power-off"></i></div>
  </span>
</div>
<div class="body_main">
  <div class="jrow">
    <div class="jcell body_mainLeft">
      <ul class="left_btngroup">
        <li class="active">
          <div><i class="fa fa-home fa-2x"></i></div>
          收银</li>
        <li>
          <div><i class="fa fa-file-text fa-2x"></i></div>
          记录 </li>
        <li>
          <div><i class="fa fa-file-text fa-2x"></i></div>
          充值记录 </li>
      </ul>
    </div>
    <div class="jcell body_mainRight"> 
      <!--page1-->
      <div class="main_window">
        <div class="jrow">
          <div class="mainW_memuleft">
            <div class="row">
              <div class="col-sm-4" style="line-height:40px" id="txt_time">{php echo date("Y-m-d")}</div>
              <div class="col-sm-4 text-center" style="line-height:40px;font-size:16px;font-weight:bold;" id="txt_title">客户下单</div>
              <div class="col-sm-4 text-right" style="line-height:40px" id="txt_no">No：{$totalOrder}</div>
            </div>
            <div class="mune_box">
              <ul>
                <li>
                  <div class="jrow">
                    <div class="jcell"><b>品名</b></div>
                    <div class="jcell"><b>数量</b></div>
                    <div class="jcell"><b>金额(元)</b></div>
                  </div>
                </li>
                </ul>
              <ul>
                <div id="goods_list" style="position:absolute; width:100%"> 
                </div>
              </ul>
              <div class="mune-sum">合计 <span class="num" id="sum_num">0</span>件<span class="pull-right">应收：<span class="price" id="sum_price">0.00</span>元</span></div>
              
              <div class="left_menubtn">
                <button type="button" id="orderBtn_holdon" class="btn btn-info orderbtn">挂单</button>
                <button type="button" id="orderBtn_getback" class="btn btn-danger orderbtn">取回</button>
                
                <button type="button" id="orderBtn_pay" class="btn btn-warning orderbtn pull-right">付款</button>
              </div>
            </div>
          </div>
          <div class="mainW_memuright">
            <div class="jtable">
              <div class="jrow">
              	<div class="select-pay jcell" style="display:none; width:100%">
                  <div class="jtable pay_boxshow">
                    <div class="jrow">
                      <div class="jcell memberinfo_box" style="width:30%; padding-bottom:10px">
                        <div style="border-bottom:1px solid #DDD;padding:5px 10px">No：<span class="pull-right">-</span></div>
                        <div style="padding:10px;">
                            <div><b>等级</b>：<span class="pull-right">-</span></div>
                            <div><b>折扣</b>：<span class="pull-right">-</span></div>
                            <div><b>积分</b>：<span class="pull-right">-</span></div>
                            <div><b>余额</b>：<span class="pull-right">-</span></div>
                        </div>
                      </div>
                      <div class="jcell" style="width:40%; padding:0 5px">
                      	<div class="jpanel pay_box">
                          <div class="jpanel-head" style="padding:8px 10px"><b>订单金额</b>：<span class="pull-right" id="txt_orderfee">0.0</span></div>
                          <div class="jpanel-body">
                            <div style="border-bottom:1px solid #DDD;padding:5px 0; margin-bottom:5px"><b>种类</b>：<span id="txt_species">0</span> <div class="pull-right"><b>数量：</b><span id="txt_num">0</span></div></div>
                            
                            <div><b>折扣</b>：<span class="pull-right" id="txt_discount">1.00</span></div>
                            <div style="border-bottom:1px solid #DDD;padding:5px 0;margin:5px 0"><b>店铺优惠</b>：<span class="pull-right" id="txt_couponfee">0.00</span></div>
                            <ul id="coupon_list">
                               {loop $marketList $row}
                               <li onclick="changeDiscount(this)" cost="{php echo sprintf('%.2f',($row['condition_fee']*0.01))}" discount="{$row['favorable']}" discounttype="1" memberid="{$row['condition_member']}" memberstr="{$row['memberstr']}" marketid="{$row['id']}"><span class="pull-right">0</span><b><i class="fa fa-square-o"></i></b> {$row['title']}</li>
                               {/loop}
                            </ul>
                            
                            <div style="border-top:1px solid #DDD;padding:10px 0 5px 0;margin-top:5px; font-size:12px; text-align:right" id="txt_remark">&nbsp;</div>
                            <div style="border-top:1px solid #DDD;padding:5px 0;margin-top:5px"><b>合计</b>：<span class="pull-right red" id="txt_totalfee">0.00</span></div>
                            
                          </div>
                        </div>
                      </div>
                      <div class="jcell pay_box">
                      	<div style="border-bottom:1px solid #DDD;padding:5px 10px; text-align:center"><b id="txt_paytype">-</b></div>
                        <div style="padding:10px;">
                            <div><b>应收</b>：<span class="pull-right" id="txt_totalfee2">0.00</span></div>
                            <div><b>实收</b>：<span class="pull-right red" id="txt_paidfee">0.00</span></div>
                            <div><b>找零</b>：<span class="pull-right" id="txt_change">0.00</span></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <input type="hidden" id="in_cardid" value=""/>
                  <input type="hidden" id="in_paytype" value=""/>
                  <input type="hidden" id="in_membercardno" value=""/>
                  <input type="hidden" id="in_password" value=""/>
                  <input type="hidden" id="in_paynum" value=""/>
                  <input type="hidden" id="in_discoun_type" value="0"/>
                  <!--'优惠类型,0没有优惠，1为满减，2为会员卡折扣，3为微信卡券，4其他优惠'-->
                  <div class="jtable" style="margin-top:10px;">
                    <div class="jrow">
                      <div class="jcell paybtnGroup" style="width:30%">
                      	 {if $shop['member_status']}
                      	 <div><button type="button" id="paybtn_membercard" class="btn btn-info btn-half">会员卡</button>
                         <button type="button" id="paybtn_clearmember" class="btn btn-info btn-half pull-right">清除会员卡</button></div>
                         {/if}
                      	<div><button type="button" id="paybtn_clearcoupon" class="btn btn-danger btn-block">清空折扣及优惠</button></div>
                        <div><button type="button" id="paybtn_card" class="btn btn-warning btn-half">微信卡券</button>
                        <button type="button" id="paybtn_othercoupon" class="btn btn-warning btn-half pull-right">其他优惠</button></div>
                        {if $shop['cash_status']}
                        <div>
                        <button type="button" id="paybtn_paycash" class="btn btn-info btn-half">现金</button>
                        <button type="button" id="paybtn_paycard" class="btn btn-info btn-half pull-right">银行卡</button>
                        </div>
                        {/if}
                        <div>
                        {if $shop['member_status']}
                        <button type="button" id="paybtn_paymember" class="btn btn-info btn-half">余额</button>
                        {/if}
                        {if $shop['ali_status'] || $shop['wechat_status']}
                        <button type="button" id="paybtn_paywechatali" class="btn btn-info btn-half pull-right">
                        {if $shop['wechat_status']}微信{/if}
                        {if $shop['ali_status']}支付宝{/if}
                        </button></div>
                        {/if}
                      </div>
                      <div class="jcell paybtnGroup" style="padding-left:10px;">
                      	<ul style="margin:0 0 4px 0">
                         	<li style="background:none;width:100%;border-color:#F1F1F1">
                              <div class="input-group" style="margin-bottom:0;"> <span class="input-group-addon">-</span>
                                <input type="text" id="txt_input" maxlength="8" value="0" class="form-control" readonly/>
                              </div>
                            </li>
                         </ul>
                      	 <ul class="payNumbtn">
                         	<li>7</li>
                            <li>8</li>
                            <li>9</li>
                            <li class="bclear"><i class="fa fa-long-arrow-left"></i></li>
                         </ul>
                         <ul class="payNumbtn">
                         	<li>4</li>
                            <li>5</li>
                            <li>6</li>
                            <li class="btn_close" onClick="$('#orderBtn_pay').click();" style="background:#d9534f;color:#FFF;">取消</li>
                         </ul>
                         <ul class="payNumbtn">
                         	<li>1</li>
                            <li>2</li>
                            <li>3</li>
                            <li class="btn_sure" onClick="doPay()">确认</li>
                         </ul>
                         <ul class="payNumbtn">
                         	<li>0</li>
                            <li>00</li>
                            <li>.</li>
                         </ul>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="select-item jcell">
                  <div class="mune-searchbox form-inline">
                    <form>
                    <div class="input-group"> <span class="input-group-addon" onClick="$('#keyword').JKeyboard({'type':1,'tips':'请输入单号/会员卡号'});"><i class="fa fa-keyboard-o"></i></span>
                      <input type="text" placeholder="搜索，输入编号，拼音" style="height:40px; line-height:40px;"id="keyword" class="form-control"/>
                      <span class="input-group-btn"><button class="btn btn-primary" style="height:40px" onClick="return seachGoods();" type="submit"><i class="fa fa-search"></i> 搜索</button></span>
                    </div>
                    </form>
                  </div>
                  <div class="select-item-outerbox"> </div>
                </div>
                <div class="select-class jcell">
                  <ul>
                    {loop $category $row}
                    <li cid="{$row['id']}" onClick="class_select({$row['id']})">{$row['title']}</li>
                    {/loop}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--page2-->
      <div class="main_window" style="display:none">
        <div class="panel panel-default">
        	<div class="panel-body form-inline">
            	<div class="input-group"> 
                    <span class="input-group-addon">搜索</span>
                    <input type="text" placeholder="请输入单号/会员卡号" id="keyno" class="form-control"/>
                    <span class="input-group-addon" onclick="$('#keyno').JKeyboard({'type':1,'tips':'请输入单号/会员卡号'});"><i class="fa fa-keyboard-o"></i></span>
                </div>
                <div class="input-group"> 
                    <span class="input-group-addon">时间</span>
                    <input class="form-control" id="datestart" type="text" style="width:120px" placeholder="请选择时间" readonly  onClick="jeDate({dateCell:'#datestart',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
                    <span class="input-group-addon">至</span> 
                     <input class="datainp form-control" id="dateend" style="width:120px" type="text" placeholder="请选择时间" readonly onClick="jeDate({dateCell:'#dateend',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
                    <span class="input-group-addon"></span>
                </div>
                <input type="button" class="btn btn-info" style="line-height:26px;" onClick="historyOrder_search()" value="搜索"/>
                {if $user['permission']>1}
                <input type="button" class="btn btn-danger" style="line-height:26px;" onClick="historyOrder_explort()" value="导出订单"/>
                <input type="button" class="btn btn-danger" style="line-height:26px;" onClick="historyOrder_explort(2)" value="导出商品"/>
                {/if}
            </div>
        </div>
        <div id="history_listbox"></div>
      </div>
      <!--page3-->
      <div class="main_window" style="display:none">
        <div class="panel panel-default">
        	<div class="panel-body form-inline">
            	<div class="input-group"> 
                    <span class="input-group-addon">搜索</span>
                    <input type="text" placeholder="请输入会员卡号" id="exchargekey" class="form-control"/>
                    <span class="input-group-addon" onclick="$('#exchargekey').JKeyboard({'type':1,'tips':'会员卡号'});"><i class="fa fa-keyboard-o"></i></span>
                </div>
                <div class="input-group"> 
                    <span class="input-group-addon">时间</span>
                    <input class="form-control" id="datestart2" type="text" style="width:120px" placeholder="请选择时间" readonly  onClick="jeDate({dateCell:'#datestart2',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
                    <span class="input-group-addon">至</span> 
                     <input class="datainp form-control" id="dateend2" style="width:120px" type="text" placeholder="请选择时间" readonly onClick="jeDate({dateCell:'#dateend2',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
                    <span class="input-group-addon"></span>
                </div>
                <input type="button" class="btn btn-info" style="line-height:26px;" onClick="historyExcharge_search()" value="搜索"/>
                {if $user['permission']>1}
                <input type="button" class="btn btn-danger" style="line-height:26px;" onClick="historyExcharge_explort()" value="导出"/>
                {/if}
            </div>
        </div>
        <div id="historyExcharge_listbox"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_getback" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        取回挂单<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body  table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>时间</th>
              <th style="text-align:right">操作</th>
            </tr>
          </thead>
          <tbody>
          	<tr rowid="" content=''>
              <td>时间</td>
              <td>应收金额</td>
              <td style="text-align:right">取回</th>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_membernew" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_membernew" onSubmit="return false;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        新开卡<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">卡号</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="text" id="newcard_cardno" class="form-control"/><span class="input-group-addon" onClick="$('#newcard_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
                <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">姓名</label>
            <div class="col-sm-9"><input type="text" id="newcard_realname" class="form-control"/></div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">电话</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="tel" id="newcard_mobile" class="form-control"/><span class="input-group-addon" onClick="$('#newcard_mobile').JKeyboard({'type':0,'tips':'请输入电话'});"><i class="fa fa-keyboard-o"></i></span></div>
                <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">密码</label>
            <div class="col-sm-9"><input type="password" id="newcard_password" class="form-control" /></div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">重复密码</label>
            <div class="col-sm-9"><input type="password" id="newcard_password2" class="form-control" /></div>
            <div class="help-block"></div>
         </div>
         
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" id="newcard_submitbtn" onClick="return newcard_submit();">新开卡</button>
      </div>
    </div>
  </div>
  </form>
</div>
<div class="modal fade" id="modal_memberrecharge" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_memberrecharge" onSubmit="return false;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        会员卡充值<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">卡号</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="text" id="recharge_cardno" class="form-control"/><span class="input-group-addon" onClick="$('#recharge_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
            <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">充值金额</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="text" id="recharge_totalfee" class="form-control"/><span class="input-group-addon" onClick="$('#recharge_totalfee').JKeyboard({'type':0,'tips':'请输入充值金额'});"><i class="fa fa-keyboard-o"></i></span></div>
             <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付方式</label>
            <div class="col-sm-9 form-inline">
            <input type="hidden" id="recharge_paytype" value="0" class="form-control" />
            <ul class="radio">
            	<li class="checked">现金支付</li><li>银行卡</li><li>微信</li><li>支付宝</li>
            </ul>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group" id="recharge_other">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">银行卡后四位</label>
            <div class="col-sm-9">
            <div class="input-group"><input type="text" id="recharge_code" class="form-control"/><span class="input-group-addon" onClick="$('#recharge_code').JKeyboard({'type':0});"><i class="fa fa-keyboard-o"></i></span></div>
            <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" id="newcard_submitbtn" onClick="return recharge_submit();">充值</button>
      </div>
    </div>
  </div>
  </form>
</div>
<div class="modal fade" id="modal_orderview" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        订单详情<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
        
      </div>
      <div class="modal-footer">
      	<button type="button" class="btn btn-danger pull-left" id="orderview_refund" onClick="">退款</button>
        <button type="button" class="btn btn-info" id="orderview_print" onClick="">打印</button>
        
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modal_orderrefund" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
    </div>
  </div>
</div>
<div class="modal fade" id="modal_tiecard" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_tiecard_cardno" onSubmit="return false;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        绑定会员卡<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">实体卡号</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="text" id="tiecard_cardno" class="form-control"/><span class="input-group-addon" onClick="$('#tiecard_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
                <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付码</label>
            <div class="col-sm-9">
            	<input type="text" id="tiecard_code" placeholder="请扫描客户的微信支付码" class="form-control"/>
            </div>
            <div class="help-block"></div>
         </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" onClick="return tiecard_submit();">新开卡</button>
      </div>
    </div>
  </div>
  </form>
</div>
<div class="modal fade" id="modal_exchange" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"> 交接班
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="newcard_submitbtn" onClick="return exchange_submit();">确认交班并退出</button>
      </div>
    </div>
  </div>
</div>
<iframe id="print_iframe" style="position:absolute; z-index:0; width:1px; height:1px;"></iframe>
<script type="text/javascript">
$(".left_btngroup li").on('click',function(){
	var _num=$(this).index();
	$(this).addClass("active").siblings().removeClass("active");
	$(".main_window").eq(_num).show().siblings().hide();
});
/*退出登录*/
function logout(){
	swal({   
		title: "确认退出登录？",
		type: "warning",
		showCancelButton: true,
		confirmButtonText: "确定",
		cancelButtonText: "取消",
		}, function(isConfirm){
			if (isConfirm){
				$.post("{php echo $this->createMobileUrl('ajax',array('op'=>'logout'))}","",function(data){
					location.href="{php echo $this->createMobileUrl('index')}";
				});
			}
		}
	);
}
//全局参数
var uniacid="{$_W['uniacid']}";
var siteroot="{$_W['siteroot']}";
var printnum=parseInt("{$shop['printnum']}");
function testPrint(){
	swal("如果不能打印，请退出重新登录");
	jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"printtype":5});
}
$(document).ready(function(e) {
    layer_floatout();
	if($(".select-class li").size()>0){
		var cid=$(".select-class li").attr("cid");
		class_select(cid);
	}
	/**/
	$("#sum_price").bind('DOMNodeInserted', function(e){
		$("#txt_orderfee").text($("#sum_price").text());
		$("#txt_num").text($("#sum_num").text());
		$("#txt_species").text($("#goods_list li").size());
		sum_payorder();
	});
});
$(window).on('resize',function(){
	layer_floatout();
})
function layer_floatout(){
	$(".body_mainLeft").height($(document).height()-50);
	$(".mainW_memuleft").height($(document).height()-90);
	$(".mune_box ul").eq(1).height($(document).height()-280);
	$(".select-item-outerbox").height($(document).height()-142);
	$(".mune_box ul").eq(1).niceScroll({touchbehavior:true});
}
function top_menu(){
	if($(".masker").size()==0){
		$("body").append('<div class="masker"></div><div id="top_menu" style="opacity:0;">{if $shop["member_status"]}<div class="row"><div class="col-sm-4"> <a href="#" onClick="newCard()"><div><p><i class="fa fa-plus-square fa-2x"></i></p>新开卡 </div></a> </div><div class="col-sm-4"> <a href="#" onClick="chargeCard()"><div><p><i class="fa fa-retweet fa-2x"></i></p>充值 </div></a> </div><div class="col-sm-4"> <a href="#" onClick="tieCard()"><div><p><i class="fa fa-puzzle-piece fa-2x"></i></p>绑定微信会员卡</div></a></div></div>{/if}<div class="row"><div class="col-sm-4"> <a href="#" onClick="cardCheck()"><div><p><i class="fa fa-credit-card fa-2x"></i></p>卡券核销 </div></a></div><div class="col-sm-4"> <a href="#" onClick="exchange()"><div><p><i class="fa fa fa-pause fa-2x"></i></p>交班 </div></a></div></div></div>');
	}
	$(".masker").width($(document).width()).height($(document).height());
	$(".masker").one('click',function(){
		$(".masker").remove();
		$("#top_menu").remove();
	});
	var _x=$(".body_top_menu").offset().left;
	var _y=$(".body_top_menu").offset().top+$(".body_top_menu").height();
	$("#top_menu").css({"top":(_y+10),"left":_x});
	$("#top_menu").transition({opacity:1,y:-10});
}
function choosePrinter(obj){
	if(obj==0){
		jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":'',"printtype":6});
	}else if(obj==1){
		$("#modal_choseprint").modal("show");
	}else if(obj==2){
		var printername=$("#choseprint option:selected").text();
		var printerindex=$("#choseprint option:selected").val();
		jetsumpay.setdefaultprinter({"uniacid":uniacid,"siteroot":siteroot,"printername":printername,"printerindex":printerindex});
		$("#modal_choseprint").modal("hide");
	}
}
function newCard(){
	$('#modal_membernew').modal("show");
}
function newcard_submit(){
	var _cardno=$("#newcard_cardno").val();
	var _realname=$("#newcard_realname").val();
	var _mobile=$("#newcard_mobile").val();
	var _password=$("#newcard_password").val();
	var _password2=$("#newcard_password2").val();
	if(_cardno.length<5){
		swal('请填写卡号');
		return false;
	}
	if(_mobile.length!=11){
		swal('请正确填写手机号码，否则将无法绑定会员卡');
		return false;
	}
	if(_password!=_password2){
		swal("两次输入的密码不一致");
		return false;
	}
	jetsumpay.newCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"realname":_realname,
		"mobile":_mobile,
		"password":_password,
		'success':function(data){
			$('#modal_membernew').modal("hide").on('hidden.bs.modal',function (e) {
				swal({   
					title: "开卡成功，是否进行充值？",
					showCancelButton: true,
					confirmButtonText: "确定",
					cancelButtonText: "取消",
					}, function(isConfirm){
						if (isConfirm){
							$("#recharge_cardno").val(_cardno)
							$("#btn_recharge").click();
						}
					}
				);
			});
			
		}
	});
	return false;
}
function chargeCard(){
	$('#modal_memberrecharge').modal("show").on('shown.bs.modal', function (e) {
	$("#recharge_other").hide();
	$("#form_memberrecharge .radio li").bind('click',function(){
		if($(this).hasClass('checked'))return;
		$(this).siblings().removeClass('checked').end().addClass('checked');
		switch($(this).index()){
			case 0:
				$("#recharge_other label").text("");
				$("#recharge_other").hide();
			break;
			case 1:
				$("#recharge_other label").text("银行卡后四位数字");
				$("#recharge_other").show();
				$("#recharge_code").focus();
			break;
			case 2:
				$("#recharge_other label").text("微信付款码");
				$("#recharge_other").show();
				$("#recharge_code").focus();
			break;
			case 3:
				$("#recharge_other label").text("支付宝付款码");
				$("#recharge_other").show();
				$("#recharge_code").focus();
			break;
		}
		$('#recharge_code').val('');
		$('#recharge_paytype').val($(this).index());
	})
  }).on('hide.bs.modal', function (e) {
	$("#recharge_other").hide();
	$("#form_memberrecharge .radio li").unbind('click');
	$('#recharge_cardno,#recharge_totalfee,#recharge_code').val('');
	$("#form_memberrecharge .radio li").removeClass("checked").eq(0).addClass("checked");
	$('#recharge_paytype').val('0');
  });
}
function recharge_submit(){
	var _cardno=$("#recharge_cardno").val();
	var _fee=$("#recharge_totalfee").val();
	var _paytype=parseInt($("#recharge_paytype").val());
	var _code=$("#recharge_code").val();
	if(_cardno.length<5){
		swal('请填写卡号');
		return false;
	}
	if(parseInt(_fee)<1){
		swal('充值金额必须为大于1的整数');
		return false;
	}
	if(_paytype>0 && _code.length<1){
		swal("请输入相关内容");
		return false;
	}
	jetsumpay.rechargeCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"fee":_fee,
		"paytype":_paytype,
		"code":_code,
		'success':function(data){
			var result=eval("("+data+")");
			jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"printtype":2,"out_trade_no":result.ordersn});
			$('#modal_memberrecharge').modal("hide").on('hidden.bs.modal',function (e) {
				swal({
					title:"充值成功￥"+_fee+"元",
					text:"账户余额：￥<b class='red'>"+(parseInt(result.item.cash)*0.01).toFixed(2)+"</b>元",
					html:true,
				});
			});
		}
	});
	return false;
}
function cardCheck(){
	payInputBox({"title":"请输入卡券号码","text":"请输入卡券号码","success":function(data){
		jetsumpay.checkCard({"uniacid":uniacid,"siteroot":siteroot,"code":data,'success':function(cardinfo){
			if(cardinfo["type"]=="discount" || cardinfo["type"]=="cash"){
				swal("折扣券和代金券只能用于支付订单");
			}else{
				swal({
					title: cardinfo['typestr'],
					text: cardinfo['msg'],
					html:true,
					closeOnConfirm: true,
					showCancelButton: true,
					confirmButtonText: "确认使用",
					cancelButtonText: "关闭",
					}, function(isConfirm){
						if(isConfirm){
							jetsumpay.cardConsume({"uniacid":uniacid,"siteroot":siteroot,"cardid":cardinfo['code'],'success':function(data){
								console.log(data);
								jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":data['id'],"printtype":1});
							}});
						}
					}
				)
			}
			
		}});
	}})
}
function tieCard(){
	$('#modal_tiecard').modal("show");
}
function tiecard_submit(){
	var _cardno=$("#tiecard_cardno").val();
	var _code=$("#tiecard_code").val();
	if(_cardno.length<1){
		$("#tiecard_cardno").focus();
		return false;
	}
	if(_code.length<11){
		$("#tiecard_code").focus();
		return false;
	}
	jetsumpay.tieCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"code":_code,
		'success':function(data){
			$('#modal_tiecard').modal("hide");
			swal("绑定成功");
		}
	});
	return false;
}
function exchange(){
	jetsumpay.doExchange({"uniacid":uniacid,"siteroot":siteroot,"success":function(html){
		$("#modal_exchange .modal-body").html(html);
		$("#modal_exchange").modal("show");
	}});
}
function exchange_submit(){
	jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"printtype":3});
	$.post("{php echo $this->createMobileUrl('ajax',array('op'=>'logout'))}","",function(data){
		location.href="{php echo $this->createMobileUrl('index')}";
	});
}
function good_select(obj){
	var _this=$(".select-box li[goodid='"+obj+"']");
	var goodid=_this.attr("goodid");
	var price=_this.attr("price");
	var title=_this.attr("title");
	var goodsn=_this.attr("goodsn");
	var _goodItem="#goods_list li[goodid='"+goodid+"']";
	if($(_goodItem).size()==0){
		var temp='<li goodid="'+goodid+'" onclick="goods_deal('+goodid+')" price="'+price+'" goodsn="'+goodsn+'" title="'+title+'"><div class="jrow"><div class="jcell">'+title+'</div><div class="jcell good_num">1</div><div class="jcell good_price">'+price+'</div></div></li>';
		if($("#goods_list li").size()){
			$("#goods_list li").eq(0).before(temp);
		}else{
			$("#goods_list").append(temp);
		}
	}else{
		var nums=parseInt($(_goodItem+" .good_num").text())+1;
		if(nums>=99){
			swal("数量不能大于99");
			return;
		}
		var _price=(parseFloat(price)*nums).toFixed(2);
		$(_goodItem+" .good_num").text(nums);
		$(_goodItem+" .good_price").text(_price);
	}
	sum_all();
}
function sum_all(){
	var all_num=0;
	var all_price=0;
	$('#goods_list .good_num').each(function(index, element) {
        all_num+=parseInt($(this).text());
    });
	$('#goods_list .good_price').each(function(index, element) {
       all_price+=parseFloat($(this).text());
    });
	$("#sum_num").text(all_num);
	$("#sum_price").text(parseFloat(all_price).toFixed(2));
}
function seachGoods(){
	var keyword=$("#keyword").val();
	if(keyword.length<1){
		swal("请输入关键字");
		$("#keyword").focus();
		return false;
	}
	$(".select-class li").removeClass("active");
	jetsumpay.getGoods({'siteroot':siteroot,'uniacid':uniacid,'keyword':keyword,'success':function(data){
		$(".select-item-outerbox").html(data);
		$(".select-box").height($(document).height()-190);
		$(".select-box").niceScroll({touchbehavior:true});
		if($(".select-box li").size()==1 && keyword.length>0){
			$(".select-box li").eq(0).click();
			$("#keyword").select().focus();
		}
	}});
	return false;
}
function class_select(obj){
	var _this=$("li[cid='"+obj+"']");
	if(_this.hasClass("active"))return;
	_this.addClass('active').siblings().removeClass("active");
	$(".select-item-outerbox").html("加载中");
	jetsumpay.getGoods({'siteroot':siteroot,'uniacid':uniacid,'pcate':obj,'success':function(data){
		$(".select-item-outerbox").html(data);
		$(".select-box").height($(document).height()-190);
		$(".select-box").niceScroll();
	}});
}
function history_page(num){
	var _keyword=$('#keyword').val();
	var _page=$("#history_pageindex").val();
	var pcate=$(".select-class .active").attr("cid");
	if(parseInt(num)){
		_page++;
	}else{
		_page--;
	}
	$(".select-item-outerbox").html("加载中");
	jetsumpay.getGoods({'siteroot':siteroot,'uniacid':uniacid,'pcate':pcate,'keyword':_keyword,'page':_page,'success':function(data){
		$(".select-item-outerbox").html(data);
		$(".select-box").height($(document).height()-190);
	}});
}
function goods_deal(obj){
	_this=$("#goods_list li[goodid='"+obj+"']");
	var _x=_this.offset().top;
	var _y=_this.offset().left;
	var _w=$("#goods_list").width();
	var num=$("#goods_list li[goodid='"+obj+"'] .good_num").text();
	if($(".gooddealmark").size()==0){
		$("body").append('<div class="gooddealmark"></div>');
		$("body").append('<div id="gooddeal"><input type="hidden" id="goods_deal_id" value="'+obj+'"/><button type="button" onclick="goods_deallist(1)" class="btn btn-info"><i class="fa fa-minus"></i></button> <input type="number" id="goods_num" maxlength="3" onfocus="this.select()" value="'+num+'"/> <button type="button" class="btn btn-info" onclick="goods_deallist(2)"><i class="fa fa-plus"></i></button> <button type="button" class="btn btn-danger" onclick="goods_deallist(0)"><i class="fa fa-trash-o"></i></button></div>');
	}
	$(".gooddealmark").width($(document).width()).height($(document).height());
	$("#goods_num").bind('input',function(){
		var val=parseInt($(this).val());
		if(val>999){
			val=999;
			$(this).val(999);
		}else if(val<1){
			val=1;
			$(this).val(1);
		}
		$("#goods_list li[goodid='"+obj+"'] .good_num").text(val);
		goods_deallist(3);
	});
	$(".gooddealmark").one('click',function(){
		$(this).remove();
		$("#goods_num").unbind('input');
		$("#gooddeal").remove();
	});
	$("#gooddeal").css({"top":_x,"left":_y,"width":_w});
}
function goods_deallist(obj){
	var id=$("#goods_deal_id").val();
	var _this=$("#goods_list li[goodid='"+id+"']");
	var num=parseInt(_this.find(".good_num").text());
	var price=parseFloat(_this.attr("price"));
	if(obj==0){
		if(confirm("是否删除？")){
			_this.remove();
			$(".gooddealmark").remove();
			$("#gooddeal").remove();
		}
	}else if(obj==1){
		if(num<=1)return;
		num--;
		var _p=(num*price).toFixed(2);
		_this.find(".good_num").text(num);
		$("#goods_num").val(num);
		_this.find(".good_price").text(_p);
	}else if(obj==2){
		if(num>=99)return;
		num++;
		var _p=(num*price).toFixed(2);
		_this.find(".good_num").text(num);
		$("#goods_num").val(num);
		_this.find(".good_price").text(_p);
	}else{
		var _p=(num*price).toFixed(2);
		_this.find(".good_num").text(num);
		_this.find(".good_price").text(_p);
	}
	sum_all();
}
function changeDiscount(obj){
	var discounttype=parseInt($(obj).attr("discounttype"));
	if(discounttype==3 && !parseInt($(obj).attr("cardtype"))){
		var _leastcost=parseFloat($(obj).attr("cost"));
		var _totalfee=parseFloat($("#order_fee").text());
		if(_totalfee<_leastcost){
			swal("该卡券必须满￥"+_leastcost+"元方可使用");
			return false;
		}
	}else if(discounttype==1){
		var _leastcost=parseFloat($(obj).attr("cost"));
		var _totalfee=parseFloat($("#order_fee").text());
		if(_totalfee<_leastcost){
			swal("必须满￥"+_leastcost+"元方可使用");
			return false;
		}
		var _memberid=$(obj).attr("memberid");
		if(_memberid){
			var _memberstr=$(obj).attr("memberstr");
			if(!$("#in_membercardno").val()){
				swal("必须是"+_memberstr+"方可使用");
				return false;
			}
			if(_memberstr.indexOf($(".memberinfo_box span:eq(1)").text())==-1){
				swal("必须是"+_memberstr+"方可使用");
				return false;
			}
		}
	}
	$(obj).addClass('active').siblings().removeClass("active");
	$(obj).find("b").html('<i class="fa fa fa-check-square"></i>');
	$(obj).siblings().find("b").html('<i class="fa fa-square-o"></i>');
	sum_payorder();
}

function getbackorder(key){
	jetsumpay.getBack({"uniacid":uniacid,"siteroot":siteroot,"key":key,"success":function(data){
		for(var i in data){
			var temp='<li goodid="'+data[i][0]+'" onclick="goods_deal('+data[i][0]+')" price="'+data[i][2]+'" goodsn="'+data[i][1]+'" title="'+data[i][4]+'"><div class="jrow"><div class="jcell">'+data[i][4]+'</div><div class="jcell good_num">'+data[i][3]+'</div><div class="jcell good_price">'+(parseInt(data[i][3])*parseFloat(data[i][2])).toFixed(2)+'</div></div></li>';
			if($("#goods_list li").size()){
				$("#goods_list li").eq(0).before(temp);
			}else{
				$("#goods_list").append(temp);
			}
		}
		sum_all();
		$("#modal_getback").modal("hide");
	}});
}
$(".orderbtn").on('click',function(){
	var btnname=$(this).attr("id");
	if(btnname=="orderBtn_holdon"){
		if($("#goods_list li").size()==0){
			return false;
		}
		var goodlist=[];
		$("#goods_list li").each(function(index, element) {
            var temp=[];
			var _id=$(this).attr("goodid");
			var _price=$(this).attr("price");
			var _goodsn=$(this).attr("goodsn");
			var _title=$(this).attr("title");
			var _num=$(this).find(".good_num").text();
			if(_id){
				temp=[_id,_goodsn,_price,_num,_title];
				goodlist.push(temp);
			}
        });
		jetsumpay.handUp({"uniacid":uniacid,"siteroot":siteroot,
			"parama":goodlist,
			"success":function(){
				$("#goods_list").empty();
			}
		});
	}else if(btnname=="orderBtn_getback"){
		if($("#goods_list li").size()>0){
			swal({
				title:"当前正有订单在处理？是否挂起此订单？",
				type: "warning",
				showCancelButton: true,
				confirmButtonText: "挂起",
				cancelButtonText: "不挂起",
				}, function(isConfirm){
					if (isConfirm){
						$("#orderBtn_holdon").click();
					}
				}
			)
		}
		jetsumpay.getBack({"uniacid":uniacid,"siteroot":siteroot,"success":function(data){
			var temp="";
			var keynum=0;
			for(var i in data){
				temp+='<tr rowid="'+keynum+'" content="'+data[i].parama+'"><td>'+data[i].sn+'</td><td style="text-align:right"><button class="btn btn-info" type="button" onclick="getbackorder(\''+keynum+'\')">取回</button></td></tr>';
				keynum++;
			}
			if(keynum==0){
				swal("没有挂单哦");
				return;
			}
			$("#modal_getback tbody").html(temp);
			$("#modal_getback").modal("show");
		}});
	}else if(btnname=="orderBtn_pay"){
		if($(".select-pay").is(":visible")){
			$(".select-pay").hide().siblings().show();
			$(this).text("付款").removeClass("btn-danger").addClass("btn-warning");
		}else{
			if($("#goods_list li").size()==0){
				return false;
			}
			$(".select-pay").show().siblings().hide();
			$(this).text("取消").removeClass("btn-warning").addClass("btn-danger");
		}
	}
});
$(".paybtnGroup button").on('click',function(){
	var btnname=$(this).attr("id");
	switch(btnname){
		case "paybtn_membercard":
			payInputBox({"title":"请输入会员卡","text":"","success":function(keyword){
				jetsumpay.seachMembercard({"uniacid":uniacid,"siteroot":siteroot,"keyword":keyword,"success":function(data){
					swal.close();
					$(".memberinfo_box span").eq(0).text((data['cardno'] ? data['cardno'] : data['wxcardno']));
					$(".memberinfo_box span").eq(1).text(data['leveltxt']);
					$(".memberinfo_box span").eq(2).text(data['discount']);
					$(".memberinfo_box span").eq(3).text(data['credit']);
					$(".memberinfo_box span").eq(4).text(data['cash']+"元");
					$("#in_membercardno").val(data['id']);
					if($("#coupon_list li[discounttype='2']").size()>0)$("#coupon_list li[discounttype='2']").remove();
					var temp='<li onclick="changeDiscount(this)" '+(data['password'].length>1 ? "ispass='1'":"")+' discount="'+data['discount']+'" discounttype="2" memberid="'+data['id']+'"><span class="pull-right">0</span><b><i class="fa fa-circle"></i></b> 会员折扣</li>';
					$("#coupon_list").append(temp);
					$("#coupon_list li[discounttype='2']").click();
					sum_payorder();
				}});
			}});
		break;
		case "paybtn_clearmember":
			jconfirm({
				"title":"是否确认清除会员信息及折扣",
				"success":function(){
					$(".memberinfo_box span").eq(0).text("-");
					$(".memberinfo_box span").eq(1).text("-");
					$(".memberinfo_box span").eq(2).text("-");
					$(".memberinfo_box span").eq(3).text("-");
					$(".memberinfo_box span").eq(4).text("-");
					$("#in_membercardno").val("");
					$("#in_password").val("");
					if($("#coupon_list li[discounttype='2']").size()>0)$("#coupon_list li[discounttype='2']").remove();
					sum_payorder();
				}
			});
		break;
		case "paybtn_clearcoupon":
			jconfirm({
				"title":"是否确认清除所有折扣优惠？",
				"success":function(){
					$(".memberinfo_box span").eq(0).text("-");
					$(".memberinfo_box span").eq(1).text("-");
					$(".memberinfo_box span").eq(2).text("-");
					$(".memberinfo_box span").eq(3).text("-");
					$(".memberinfo_box span").eq(4).text("-");
					if($("#coupon_list li").size()>0)$("#coupon_list li").removeClass("active");
					if($("#coupon_list li[discounttype='2']").size()>0)$("#coupon_list li[discounttype='2']").remove();
					if($("#coupon_list li[discounttype='3']").size()>0)$("#coupon_list li[discounttype='3']").remove();
					if($("#coupon_list li[discounttype='4']").size()>0)$("#coupon_list li[discounttype='4']").remove();
					$("#in_cardid").val("");
					$("#in_membercardno").val("");
					sum_payorder();
					$("#txt_remark").text("");
				}
			});
		break;
		case "paybtn_card":
			payInputBox({"title":"请输入卡券号码","text":"","success":function(keyword){
				if($("#coupon_list li[discountid='"+keyword+"']").size()>0){
					swal("该卡券已添加");
					$("#coupon_list li[discountid='"+keyword+"']").click();
					return false;
				}
				jetsumpay.checkCard({"uniacid":uniacid,"siteroot":siteroot,"code":keyword,"success":function(cardinfo){
					if(cardinfo["type"]=="discount" || cardinfo["type"]=="cash"){
						if(parseInt($("#txt_orderfee").text()*100)==0){
							swal("使用代金券/折扣券时，请先输入应收金额");
							return false;
						}
						var _totalfee=parseFloat($("#txt_orderfee").text());
						var _least_cost=parseInt(cardinfo['least_cost']) ? parseInt(cardinfo['least_cost']) : 0;
						var _discount=parseInt(cardinfo['discount']);
						var cardtype=cardinfo["type"]=="discount" ? 1 : 0;
						var _til=cardinfo["type"]=="discount" ? "折扣券" : "代金券";
						var _txt=cardinfo["type"]=="discount" ? "应付金额打<b class='red'>"+(_discount*0.1)+"</b>折" :"满￥<b class='red'>"+(_least_cost*0.01).toFixed(2)+"</b>元减￥<b class='red'>"+(_discount*0.01).toFixed(2)+"</b>元";
						_txt+="<br>是否使用此卡券？";
						jconfirm({
							"title":_til,
							"text":_txt,
							"success":function(){
								var _til="";
								if(cardinfo["type"]=="discount"){
									_til="折扣券优惠";
								}else{
									_til="代金券优惠";
								}
								$("#coupon_list").append('<li onclick="changeDiscount(this)" cost="'+(_least_cost*0.01).toFixed(2)+'" cardtype="'+cardtype+'" discount="'+(_discount*0.01)+'" discounttype="3" discountid="'+cardinfo['code']+'"><span class="pull-right">0</span><b><i class="fa fa-square-o"></i></b> '+_til+'</li>');
								
								sum_payorder();
								$("#coupon_list li[discountid='"+cardinfo['code']+"']").click();
								//$("#txt_remark").text(_txt+$("#txt_couponfee").text()+"元");
							}
						});	
					}else{
						swal("付款只支持折扣/代金券");
					}
				}});
			}});
		break;
		case "paybtn_othercoupon":
			
		break;
		case "paybtn_paycash":
			payInputBox({"title":"收取现金","text":"","success":function(num){
				var _num=parseFloat(num);
				var _txt_totalfee=parseFloat($("#txt_totalfee").text());
				if(_txt_totalfee>_num){
					swal("金额不足！");
					return ;
				}
				$("#txt_paytype").text("现金");
				$("#txt_paidfee").text(parseFloat(_num).toFixed(2));
				$("#in_paytype").val(2);
				sum_payorder();
				setTimeout(function(){doPay();},500);
			}});
		break;
		case "paybtn_paycard":
			payInputBox({"title":"银行卡","text":"请输入银行卡后四位数字","success":function(num){
				if(num.length!=4){
					swal("请输入银行卡最后4位数字");
					return ;
				}
				$("#txt_paytype").text("银行卡"+num);
				$("#txt_paidfee").text($("#txt_totalfee").text());
				$("#in_paytype").val(3);
				sum_payorder();
				setTimeout(function(){doPay();},500);
			}});
		break;
		case "paybtn_paymember":
			var _totalfee=parseFloat($("#txt_totalfee").text())*100;
			if(!_totalfee){
				swal("请先选择商品");
				return;
			}
			var cardno=$("#in_membercardno").val();
			if(!cardno){
				$("#paybtn_membercard").click();
				return;
			}
			jetsumpay.seachMembercard({"uniacid":uniacid,"siteroot":siteroot,"id":cardno,"success":function(data){
				if(parseFloat(data['cash'])*100<_totalfee){
					swal("余额不足，剩余"+data['cash']+"元");
					return;
				}
				$("#txt_paytype").text("会员卡余额");
				$("#txt_paidfee").text(data['cash']);
				$("#txt_change").text("0.00");
				$("#in_paytype").val(4);
				sum_payorder();
				if(data['password'].length>1){
					payInputBox({"title":"请输入密码","text":"","password":"1","success":function(num){
						jetsumpay.seachMembercard({"uniacid":uniacid,"siteroot":siteroot,"id":cardno,"password":num,"success":function(data){
							$("#in_password").val(num);
							setTimeout(function(){doPay();},500);
						}});
					}});
				}else{
					setTimeout(function(){doPay();},500);
				}
			}});
		break;
		case "paybtn_paywechatali":
			var _txt_totalfee=parseFloat($("#txt_totalfee").text());
			if(_txt_totalfee==0){
				swal("请先输入金额！");
				return ;
			}
			payInputBox({"title":"电子支付","text":"请扫描客户的付款码","success":function(num){
				var _temp=num.substr(0,1);
				var paytype=0;
				var _til="微信支付";
				if(_temp==2){paytype=1;_til="支付宝支付";}
				$("#in_paynum").val(num);
				$("#txt_paytype").text(_til);
				$("#txt_paidfee").text($("#txt_totalfee").text());
				$("#in_paytype").val(paytype);
				setTimeout(function(){doPay();},500);
			}});
		break;
	}
});
function doPay(){
	if($("#in_paytype").val().length==0 || parseFloat($("#txt_paidfee").text())==0){
		swal("请选择支付方式");
		return ;
	}
	jconfirm({
		"title":"确认支付",
		"success":function(){
			swal({title:"系统处理中",showConfirmButton:false});
			var goodslist=[];
			$('#goods_list li').each(function(index, element) {
				var temp_1=$(this).attr("goodid");
				var temp_2=$(this).attr("goodsn");
				var temp_3=$(this).attr("price");
				var temp_4=$(this).find(".good_num").text();
				//var temp=[goodid,goodsn,oprice,price,num,goodfee];
				var temp=[temp_1,temp_2,temp_3,temp_3,temp_4];
				goodslist.push(temp);
			});
			
			var changefee=parseFloat($("#txt_change").text().replace("￥",""));
			var discountfee=parseFloat($("#coupon_list li.active span").text().replace("￥",""));
			var discounttype=parseInt($("#coupon_list li.active").attr("discounttype"));
			var cardid=$("#coupon_list li.active").attr("discountid") ? $("#coupon_list li.active").attr("discountid") :"";
			var marketid=parseInt($("#coupon_list li.active").attr("marketid")) ? parseInt($("#coupon_list li.active").attr("marketid")) : 0;
			var discount=1;
			if(discounttype==2){
				discount=$("#coupon_list li.active").attr("discount");
			}else if(discounttype==3){
				if(parseInt($("#coupon_list li.active").attr("cardtype"))){
					discount=$("#coupon_list li.active").attr("discount");
				}
			}
			jetsumpay.payAll({"uniacid":uniacid,"siteroot":siteroot,
				"goods":goodslist,
				"paytype":$("#in_paytype").val(),
				"orderfee":$("#txt_orderfee").text(),
				"couponfee":discountfee,
				"discount":discount,
				"marketid":marketid,
				"totalfee":$("#txt_totalfee").text(),
				"paidfee":$("#txt_paidfee").text(),
				"change":$("#txt_change").text(),
				"cardid":$("#in_cardid").val(),
				"memberno":$("#in_membercardno").val(),
				"password":$("#in_password").val(),
				"code":$("#in_paynum").val(),
				"discounttype":discounttype,
				"remark":$("#txt_remark").text(),
				"success":function(data){
					jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":data});
					jetsumpay.paySuccess({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":data,"success":function(ordernum){
						$("#txt_no").text("No："+ordernum);
						swal({   
							title: "收款成功",
							showLoaderOnConfirm: true,
							}, function(){
								swal({title:"收款成功",showConfirmButton:false,timer:3000});
								setTimeout(function(){location.reload()},3500)
						});
					}});
				}
			});
		}
	});
}
function sum_payorder(){
	var total_price=parseFloat($("#txt_orderfee").text());
	var discount_fee=0;
	if($("#coupon_list li").size()>0){
		$("#coupon_list li").each(function(index, element){
            var _dis_type=$(this).attr("discounttype");
			if(_dis_type==1){
				var _discount=$(this).attr("discount");
				var fee=0;
				if(_discount.indexOf("%")>-1){
					_discount=parseFloat(_discount.replace("%",""))*0.01;
					fee=_discount*total_price;
				}else{
					fee=_discount;
				}
				$(this).find("span").text("￥ -"+(parseFloat(fee).toFixed(2)));
			}else if(_dis_type==2){
				var _discount=parseFloat($(this).attr("discount"));
				var fee=total_price*(1-_discount);
				$(this).find("span").text("￥ -"+(parseFloat(fee).toFixed(2)));
			}else if(_dis_type==3){
				var _discount=parseFloat($(this).attr("discount"));
				var _distype=parseInt($(this).attr("cardtype"));
				var fee=0;
				if(_distype){
					fee=total_price*(1-_discount);
				}else{
					fee=_discount;
				}
				$(this).find("span").text("￥ -"+(parseFloat(fee).toFixed(2)));
			}
			if($(this).hasClass("active")){
				discount_fee=parseFloat($(this).find("span").text().replace("￥","").replace("-","").replace(" ",""));
			}
        });
	}
	var sum_fee=total_price-discount_fee;
	var pai_fee=0;
	$("#txt_totalfee,#txt_totalfee2").text(parseFloat(sum_fee).toFixed(2));
	var pai_fee=parseFloat($("#txt_paidfee").text());
	var change_fee=parseFloat(pai_fee-sum_fee);
	$("#txt_change").text(parseFloat(change_fee).toFixed(2));
}
function resetAll(){
	$("#goods_list").empty();
	$("#sum_num").text("0");
	$("#sum_price").text("0.00");
	$("#in_cardid,#in_paytype,#in_membercardno,#in_password,#in_paynum,#in_discoun_type").val("");
	$(".memberinfo_box span,#txt_paytype").text("-");
	$("#txt_discount").text("1.00");
	$("#txt_orderfee,#txt_couponfee,#txt_totalfee,#txt_totalfee2,#txt_paidfee,#txt_change").text("0.00");
	$("#txt_remark").text("");
	$('#orderBtn_pay').click();
}
/*page2*/
function historyOrder_print(ordersn){
	jconfirm({"title":"是否打印订单？","success":function(){
		jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn});
	}});
}
function historyOrder_show(ordersn){
	jetsumpay.getOrderView({"uniacid":uniacid,"siteroot":siteroot,"keyword":ordersn,"success":function(data){
		$("#modal_orderview .modal-body").html(data);
		$("#modal_orderview").modal("show");
		$("#orderview_refund").attr("onclick","historyOrder_refund("+ordersn+")");
		$("#orderview_print").attr("onclick","historyOrder_print("+ordersn+")");
		
	}});
}
function historyOrder_search(){
	var _keyword=$('#keyno').val();
	var _ds=parseInt($('#datestart').val().split("-").join(""));
	var _de=parseInt($('#dateend').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart').val();
	_de=$('#dateend').val();
	jetsumpay.getOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'success':function(data){
		$("#history_listbox").html(data);
	}});
}
function historyOrder_page(num){
	var _keyword=$('#keyno').val();
	var _ds=$('#datestart').val();
	var _de=$('#dateend').val();
	var _page=parseInt($("input[name='historyOrder_pageindex']").val());
	if(num==1){
		
		_page++;
	}else if(num==0){
		_page--;
	}else if(num==3){
		_page=_page;
	}else{
		
	}
	jetsumpay.getOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'page':_page,'success':function(data){
		$("#history_listbox").html(data);
	}});
}
function historyOrder_explort(){
	var op=0;
	if(arguments[0])op=2;
	var _keyword=$('#keyno').val();
	var _ds=parseInt($('#datestart').val().split("-").join(""));
	var _de=parseInt($('#dateend').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart').val();
	_de=$('#dateend').val();
	var url='{php echo $this->createMobileUrl("explode")}&keyword='+_keyword+'&ds='+_ds+'&de='+_de+'&op='+op;
	window.open(url);
}
function historyOrder_refund(ordersn){
	jetsumpay.getrefundView({"uniacid":uniacid,"siteroot":siteroot,"keyword":ordersn,"success":function(data){
		$("#modal_orderrefund .modal-content").html(data);
		$("#modal_orderrefund").modal("show");
		$("#modal_orderview").modal("hide");
	}});
}
function do_refund(type,ordersn){
	var total=parseInt($("input[name='orderrefund_total_fee']").val());
	var refundfee=parseInt($("input[name='orderrefund_refundfee']").val());	
	if(type==1){
		if($("input[name^='good_id']:checked").size()==0){
			swal("选择需要退货的商品");
			return;
		}
		var fee=0;
		var tempary=[];
		$("input[name^='good_id']:checked").each(function(index, element) {
            var id=$(this).val();
			tempary.push(id);
			fee+=parseFloat($("tr[rows='"+id+"']").find(".refund-fee").text());
        });
		if(total-refundfee<fee*100){
			swal("可退款金额"+(((total-refundfee)*0.01).toFixed(2)));
			return;
		}
		jconfirm({"title":"本次退款<b class='red'>"+(parseFloat(fee).toFixed(2))+"</b>元，确认退款？","text":"","success":function(){
			jetsumpay.getRefund({"uniacid":uniacid,"siteroot":siteroot,"ordersn":ordersn,'fee':0,'goods':tempary.join(","),'success':function(data){
				swal("退款成功");
				jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn,"printtype":4});
				$("#modal_orderrefund").modal("hide");
				historyOrder_page(3);
			}});
		}});
	}else{
		payInputBox({"title":"请输入退款金额","text":"可退款金额"+(((total-refundfee)*0.01).toFixed(2))+"元","success":function(num){
			if(total-refundfee<parseFloat(num)*100){
				swal("可退款金额"+(((total-refundfee)*0.01).toFixed(2)));
				return;
			}
			jetsumpay.getRefund({"uniacid":uniacid,"siteroot":siteroot,"ordersn":ordersn,'fee':num,'goods':"",'success':function(data){
				swal("退款成功");
				jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn,"printtype":4});
				$("#modal_orderrefund").modal("hide");
				historyOrder_page(3);
			}});
		}});
	}
}
function checkpay(ordersn){
	if(!ordersn)return false;
	swal({title:"系统处理中",showConfirmButton:false});
	jetsumpay.reCheckPay({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn,'success':function(data){
		swal("支付成功");
		historyOrder_page(3);
	}});
}
function selectAllGoodid(obj){
	$("input[name^='good_id']").prop("checked",$(obj).prop("checked"));
}
/*page3*/
function historyExcharge_search(){
	var _keyword=$('#exchargekey').val();
	var _ds=parseInt($('#datestart2').val().split("-").join(""));
	var _de=parseInt($('#dateend2').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart2').val();
	_de=$('#dateend2').val();
	jetsumpay.getExchargeOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'success':function(data){
		$("#historyExcharge_listbox").html(data);
	}});
}
function historyExcharge_page(num){
	var _keyword=$('#exchargekey').val();
	var _ds=$('#datestart2').val();
	var _de=$('#dateend2').val();
	var _page=$("#historyExcharge_pageindex").val();
	if(parseInt(num)){
		_page++;
	}else{
		_page--;
	}
	jetsumpay.getExchargeOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'page':_page,'success':function(data){
		$("#historyExcharge_listbox").html(data);
	}});
}
function historyExcharge_explort(){
	var _keyword=$('#exchargekey').val();
	var _ds=parseInt($('#datestart2').val().split("-").join(""));
	var _de=parseInt($('#dateend2').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart2').val();
	_de=$('#dateend2').val();
	var url='{php echo $this->createMobileUrl("explode",array("op"=>1))}&keyword='+_keyword+'&ds='+_ds+'&de='+_de;
	window.open(url);
}
function historyExcharge_print(ordersn){
	jconfirm({"title":"是否打印订单？","success":function(){
		jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn,"printtype":2});
	}});
}
</script>
{/if} 
