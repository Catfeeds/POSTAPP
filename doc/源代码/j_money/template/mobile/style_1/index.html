<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>{$shop['companyname']}收银台</title>
<meta name="format-detection" content="telephone=no, address=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-touch-fullscreen" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link href="{MODULE_URL}image/css/bootstrap.min.css" rel="stylesheet">
<link href="{MODULE_URL}image/css/font-awesome.min.css" rel="stylesheet">
<link href="{MODULE_URL}image/css/common.css" rel="stylesheet">
<script src="{MODULE_URL}template/js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" charset="utf-8" src="{MODULE_URL}image/js/lib/bootstrap.min.js"></script>
<script src="{MODULE_URL}template/js/sweetalert.min2.js"></script>
<link type="text/css" rel="stylesheet" href="{MODULE_URL}template/js/sweetalert.css"/>
<script src="{MODULE_URL}template/js/jquery.transit.js"></script>
<script src="{MODULE_URL}template/js/radialIndicator.min.js"></script>
<script src="{MODULE_URL}template/mobile/style_1/jetsum.fun.min.js"></script>
<script src="{MODULE_URL}template/js/JKeyboard.js"></script>
<link type="text/css" rel="stylesheet" href="{MODULE_URL}template/js/JKeyboard.css"/>
<script src="{MODULE_URL}template/js/jedate/jedate.min.js"></script>
</head>
<body>
{if $operation=='display'}
<style>
html{ height:100%;}
body{height:100%; overflow:hidden; background:url({php echo $shop['bg'] ? tomedia($shop['bg']): tomedia($cfg['bg'])}); background-size:100% 100%;}
.login_body{display:table; width:80%; margin:0 auto; text-align:center}
.jrow{ display:table-row;}
.jcell{ display:table-cell; width:100%;vertical-align:middle; text-align:center; height:100%; text-align:center;}
.logo{ margin-bottom:40px;}
.logo img{ height:100%}
.font24{ font-size:24px;color:#FFF}
.btns{ display:inline-block;width:210px; margin-top:20px}
.progress{ width:200px; margin:0 auto; opacity:0;}
.keyboardbtn{ position:absolute; z-index:33; border:1px solid #CCC; box-shadow:0px 0px 2px #FFF; padding:10px; border-radius:8px;right:20px; bottom:20px;background:#FFF; color:#09F;}
.keyboardon{color:#FFF; background:#09F;}
</style>
<!--登录-->
<div class="login_body">
  <div class="jcell">
    <div class="logo"><img src="{php echo tomedia($_GPC['cookie_logo'])}" onerror="this.style.display='none'"/></div>
    <div class="form-inline">
      <div class="input-group" id="box_user"> <span class="input-group-addon"><i class="fa fa-user"></i></span>
        <input type="text" class="form-control" name="username" />
      </div>
      <span class="font24">&middot;</span><span class="font24">&middot;</span><span class="font24">&middot;</span> <img src="{php echo tomedia($_GPC['cookie_headimg'])}" onerror="this.src='{MODULE_URL}template/img/head.jpg'" style="vertical-align:middle" class="img-circle img-thumbnail logohead"/> <span class="font24">&middot;</span><span class="font24">&middot;</span><span class="font24">&middot;</span>
      <div class="input-group" id="box_pass">
        <input type="password" class="form-control" name="pwds" />
        <span class="input-group-addon"><i class="fa fa-key"></i></span> </div>
    </div>
    <div class="submitbtn">
      <button type="button" class="btn btn-primary btns" onClick="checkUpdate()" ><i class="fa fa-unlock"></i> 登陆</button>
    </div>
    <div class="progress">
      <div class="progress-bar progress-bar-striped active" role="progressbar"> <span class="sr-only"></span> </div>
    </div>
  </div>
</div>
<div class="keyboardbtn"><i class="fa fa-keyboard-o fa-2x"></i></div>
<script language="javascript">
$(document).ready(function(e) {
    var _h=$(document).height();
	$(".jcell").height(_h);
});
$(".keyboardbtn").on('click',function(){
	if($(this).hasClass('keyboardon')){
		$(this).removeClass('keyboardon');
		$('input[name="username"]').unbind('click');
		$('input[name="pwds"]').unbind('click');
		$(this).JKeyboard({'show':false})
	}else{
		$(this).addClass('keyboardon');
		$('input[name="username"]').bind('click',function(){
			$('input[name="username"]').JKeyboard({'type':1,'val':'','tips':'请输入账号'});
		})
		$('input[name="pwds"]').bind('click',function(){
			$('input[name="pwds"]').JKeyboard({'type':1,'val':'','tips':'请输入密码'});
		})
	}
})

function checkUpdate(){
	var userid=$("input[name='username']").val();
	var pwd=$("input[name='pwds']").val();
	if(userid.length<1){
		swal("用户名不能为空");
		return false;
	}
	if(pwd.length<6){
		swal("密码长度不正确");
		return false;
	}
	jetsumpay.logIn({
		"uniacid":"{$_W[uniacid]}","siteroot":"{$_W[siteroot]}","userid":userid,"pwd":pwd,
		"success":function(result){
			$("#box_user").transition({ x:30,opacity:0 });
			$("#box_pass").transition({ x:-30,opacity:0 });
			$(".btns").transition({opacity:0});
			$(".logohead").transition({ y:-20,});
			$(".progress").transition({opacity:1,y:-50}, function(){
			  $(".progress-bar").transition({width:'100%'}, function(){
				  location.href="{php echo $this->createMobileUrl('index',array('op'=>'in'))}";
			  });
			});
			
		},
		"falsed":function(result){
			swal(result);
		}
	});
	return false;
}
</script> 
{else}
<!--登录成功-->
<style>
ul,li{list-style:none; padding:0; margin:0;}
html{ height:100%;}
body{height:100%; background:#F1F1F1;color:#333}
.jtable{ display:table; width:100%;}
.jrow{ display:table-row;}
.jcell{ display:table-cell;}
.jbox{display:-webkit-box;display:box;}
.fx1{-webkit-box-flex:1;box-flex:1;}
.fx2{-webkit-box-flex:2;box-flex:2;}
.fx3{-webkit-box-flex:3;box-flex:3;}
.fx3{-webkit-box-flex:4;box-flex:4;}
.fx3{-webkit-box-flex:5;box-flex:5;}
.fx6{-webkit-box-flex:6;box-flex:6;}
.fx7{-webkit-box-flex:7;box-flex:7;}
.fx8{-webkit-box-flex:8;box-flex:8;}
.fx9{-webkit-box-flex:9;box-flex:9;}
.red{color:#F00}
.hiden{ display:none;}
.labelBtn{display:inline-block;position:relative; cursor:pointer;}
.labelBtn .label{ font-size:60%; position:absolute; z-index:2; right:0; top:3px; font-weight:normal}
.body_top{line-height:50px; height:50px; background:#18BC9C; overflow:hidden;}
.body_top_logo{ display:inline-block; width:226px; text-align:center; background:#1B2428;}
.body_top_logo img{ max-width:210px; max-height:46px;}
.body_top_menu{display:inline-block; line-height:50px; padding:0 15px; background:#303641;color:#FFF;}
.body_top_btn{line-height:30px;padding:10px 15px 0 15px;color:#FFF;}
.body_top_user{ color:#FFF; margin:-1px 20px 0 20px; display:inline-block;}
.body_top_logout{display:inline-block; line-height:49px; text-align:center; width:49px; background:#232B2D;color:#18BC9C; font-size:20px; margin-top:-1px; cursor:pointer;}
.body_main{display:table; width:100%;}
.body_mainLeft{ width:80px; vertical-align:top; background:#1B2428; height:80%;color:#FFF; overflow:hidden;}

ul.left_btngroup li{text-align:center; padding:10px 5px;color:#80969C;border-left:3px solid #1B2428; border-bottom:#000;color:#80969C; cursor:pointer;}
ul.left_btngroup li i{color:#80969C;}
ul.left_btngroup li div{}
ul.left_btngroup li:hover{background:#23BAB5; color:#FFF;border-left:3px solid #23BAB5;}
ul.left_btngroup li:hover i{color:#FFF}
ul.left_btngroup li.active{ border-left:3px solid #23BAB5; color:#FFF;}
ul.left_btngroup li.active i{color:#FFF}
.body_mainRight{vertical-align:top; padding:10px;}
ul.right_showbox li{ display:inline-block;box-shadow:0px 0px 1px #AAA; border-radius:4px; padding:5px; width:19.3%; margin-right:0.3%; background:#FFF; }
._bm_color1{border-bottom:1px solid #6CADD1}
._bm_color2{border-bottom:1px solid #DF6C6E}
._bm_color3{border-bottom:1px solid #eac841}
._bm_color4{border-bottom:1px solid #A0D269}
._bm_color5{border-bottom:1px solid #23BAB5}
ul.right_showbox li:last-child{ margin:0;}
ul.right_showbox li .pricenum{ font-size:18px; font-family:Arial, Helvetica, sans-serif; margin-top:3px; }
ul.right_showbox li .pricenum small{ font-size:12px;}
.right_main_input{ margin-top:10px;}
.right_l,.right_m{ width:35%; padding-right:10px; vertical-align:top;}
.right_r{ padding:0 8px 8px 8px;font-size:16px; vertical-align:top;}
.right_r span{ float:right;}
.right_main_input .input-group{ margin-bottom:8px;}
.right_main_input .input-group input{ line-height:30px; font-size:20px; text-align:right;}
.bg-while span{background:#FFF;}
ul.right_btngroup{ margin-bottom:8px; position:relative;}
ul.right_btngroup li{ display:inline-block; height:88px;width:32.1%; margin-right:0.3%; border-radius:4px; border:1px solid #CCC; background:#FFF; text-align:center; padding:15px 0 0 0; font-size:16px; cursor:pointer;}

ul.right_btngroup li:last-child{ margin:0;}
ul.right_btngroup li:active{ background:#2196F3;color:#FFF;}
ul.right_btngroup li.btnsure{background:#5CB85C;color:#FFF;}
ul.right_btngroup li.btn_start{background:#EAA559;color:#FFF;}
ul.right_btngroup li.btn_exchange{background:#1693D2;color:#FFF;}
ul.right_btngroup li.disabled{ background:#DDD;color:#333;}
ul.right_btngroup li.active{background:#DF6C6E;color:#FFF;}
.right_counter{}
.right_counter ul{ margin-bottom:8px; position:relative;}
.right_counter ul li{ display:inline-block; width:24.5%; margin-right:0.4%;border-radius:4px; line-height:61px; font-size:24px; border:1px solid #CCC; background:#FFF; text-align:center; cursor:pointer;}
.right_counter ul li:last-child{ margin:0;}

#in_change{color:#00F}
.doct{ padding:0 0 3px 0; margin-bottom:3px; border-bottom:1px dashed #999}
/**/
ul.radio li{ display:inline-block; padding:5px 0; width:74px; text-align:center; margin:0 10px 10px 0;border:1px solid #CCC; border-radius:4px; cursor:pointer}
ul.radio li i{ font-size:30px;}
ul.radio li.checked{ border-color:#ffc107; background:#ffc107; color:#FFF;}
/**/
.sweet-counter-box{ text-align:left;}
.sweet-counter-box ul { position:relative;}
.sweet-counter-box ul li{display:inline-block;width:24.3%; margin:2px 0.2%; text-align:center; line-height:40px; border:1px solid #CCC; border-radius:4px; font-size:18px; cursor:pointer;}
.sweet-counter-box .sweet-counter-c{position:absolute; z-index:2; height:134px;padding-top:46px}
.sweet-counter-box .sweet-counter-0{width:48.8%}
.sweet-counter-box ul li:hover,.sweet-counter-box ul li:active{ background:#CCC;}
.historybox{ width:100%; min-width:100%;}
.historybox td{padding:6px;}
.historybox th{padding:0 6px; font-weight:bolder;}
.line-box{border:1px solid #6CADD1; margin:5px 0; border-radius:4px;}
.line-box h2{ border-top-left-radius:4px;border-top-right-radius:4px; text-align:left; font-size:14px; border-bottom:1px solid #6CADD1;padding:10px; margin:0;}
.line-box div{padding:10px;color:#23BAB5}
.masker{width:100%;background:rgba(0,0,0,0.5);position:absolute; z-index:3; left:0; top:0;}
#top_menu{position:absolute;z-index:4; background:#FFF; box-shadow:0px 0px 5px #FFF;border-radius:4px;min-width:420px;}
#top_menu a{display:block;text-align:center;height:100px;line-height:100px;color:#333}
#top_menu a:hover{text-decoration:none;background:#E7E7E7}
#top_menu a div{line-height:24px;padding-top:25px;}
#top_menu a div p{margin:0;}
.red2{color:#DF6C6E;}
#member_header{border:1px solid #CCC;width:80px; height:80px;}
.member_infobox{border:1px solid #CCC;border-radius:8px;padding:10px;height:280px;margin-bottom:10px;margin-right:12px;background:#FFF; font-size:16px;}
.member_infobox ul{ border-top:1px dashed #CCC; margin-top:10px; padding-top:5px}
.member_infobox ul li{ line-height:30px; color:#999}
.member_infobox ul li span{line-height:30px;color:#333}
#coupon_list{border:1px solid #CCC;border-radius:8px;padding:0 10px 10px 10px; margin-bottom:10px; background:#FFF;}
#coupon_list h2{ font-size:16px; text-align:left; border-bottom:1px solid #CCC; margin:5px 0 10px 0; padding:5px 0 10px 0}
#coupon_list ul li{line-height:26px;cursor:pointer;}
#coupon_list ul li.active{color:#489AFE;font-weight:bold}
#coupon_list ul li.active b{color:#489AFE;}
#print_show{border:1px solid #CCC;border-radius:8px;padding:10px;background:#FFF; line-height:24px}
.goodlist{}
.goodlist ul,.goodlist ul li{ list-style:none; margin:0; padding:0;}
.goodlist ul li{ display:inline-block; width:23.5%; margin:6px 0.5px; border:1px solid #CCC; border-radius:4px; padding:5px 0}
.goodlist ul li:active{ background:#09F;color:#FFF;}
</style>
<div class="body_top">
  <div class="body_top_logo"><img src="{php echo tomedia($shop['logo'])}" onerror="this.style.display='none'"/></div><div class="body_top_menu" onClick="top_menu()"><i class="fa fa-th"></i> 主菜单</div>
  <span class="pull-right">
  <div class="body_top_btn labelBtn" onClick="testPrint()"><i class="fa fa-print fa-2x"></i></div>
  <div class="body_top_user">{$user['realname']} <img src="{php echo tomedia($user['headimg'])}" onerror="this.src='{MODULE_URL}template/img/head.jpg'" width="36" class="img-circle img-thumbnail"/> <i class="fa fa-angle-down"></i></div>
  <div class="body_top_logout" onClick="logout();"><i class="fa fa-power-off"></i></div>
  </span> </div>
<div class="body_main">
  <div class="jrow">
    <div class="jcell body_mainLeft">
      <ul class="left_btngroup">
        <li class="active">
          <div><i class="fa fa-home fa-2x"></i></div>
          收银</li>
        <li>
          <div><i class="fa fa-home fa-2x"></i></div>
          记录 </li>
      </ul>
    </div>
    <div class="jcell body_mainRight">
      <div class="main_window" id="win_pay">
        <ul class="right_showbox">
          <li class="_bm_color1"> <span class="pull-right text-right">
            <div class="pricenum"><small>￥</small> 0.00</div>
            <span class="label label-danger">总收入</span> </span>
            <div id="circle_1"></div>
          </li>
          <li class="_bm_color2 {if !$shop['ali_status'] && !$shop['wechat_status']}hide{/if}"> <span class="pull-right text-right">
            <div class="pricenum"><small>￥</small> 0.00</div>
            <span class="label label-success">电子支付</span> </span>
            <div id="circle_2"></div>
          </li>
          <li class="_bm_color3 {if !$shop['cash_status']}hide{/if}"> <span class="pull-right text-right">
            <div class="pricenum"><small>￥</small> 0.00</div>
            <span class="label label-warning">现金</span> </span>
            <div id="circle_3"></div>
          </li>
          <li class="_bm_color4 {if !$shop['cash_status']}hide{/if}"> <span class="pull-right text-right">
            <div class="pricenum"><small>￥</small> 0.00</div>
            <span class="label label-warning">银行卡</span> </span>
            <div id="circle_4"></div>
          </li>
          <li class="_bm_color5 {if !$shop['member_status']}hide{/if}"> <span class="pull-right text-right">
            <div class="pricenum"><small>￥</small> 0.00</div>
            <span class="label label-info">充值</span> </span>
            <div id="circle_5"></div>
          </li>
        </ul>
        {if $user['permission']!=2}
        <div class="jtable right_main_input">
          <div class="jrow">
            <div class="jcell right_l">
              <div class="member_infobox">
              	<div class="jbox">
                	<div class="fx2"><img src="{MODULE_URL}template/img/nohead.png" style="width:80;height:80px" id="member_head"/></div>
                    <div class="fx9" style="padding-left:10px">
                    	<div style="margin:10px 0 5px 0"><span class="label label-default">姓名</span> <span id="member_name"></span></div>
                        <div style="margin:0 0 5px 0"><span class="label label-default">电话</span> <span id="member_mobile"></span></div>
                        <div><span class="label label-default">密码</span> <span id="member_passowrd"></span></div>
                    </div>
                </div>
                <ul>
                	<li><span class="pull-right" id="member_no"></span>会员卡号</li>
                    <li><span class="pull-right" id="member_level"></span>会员等级</li>
                    <li><span class="pull-right" id="member_credit"></span>会员积分</li>
                    <li><span class="pull-right" id="member_discount"></span>会员折扣</li>
                    <li><span class="pull-right" id="member_cash"></span>会员余额</li>
                </ul>
              </div>
              <!--按钮--> 
              {if $shop['member_status']}
              <ul class="right_btngroup">
                <li id="btn_newcard">
                  <div><i class="fa fa-plus fa-2x"></i></div>
                  新开卡 </li>
                <li id="btn_recharge">
                  <div><i class="fa fa-dashboard fa-2x"></i></div>
                  充值 </li>
                <li id="btn_refund">
                  <div><i class="fa fa-sign-out fa-2x"></i></div>
                  退款 </li>
              </ul>
              {/if}
              <ul class="right_btngroup">
                {if $shop['member_status']}
                <li id="btn_membercard"  class="disabled">
                  <div><i class="fa fa-user fa-2x"></i></div>
                  会员卡 </li>
                {/if}
                <li id="btn_card">
                  <div><i class="fa fa-tag fa-2x"></i></div>
                  卡券 </li>
              </ul>
            </div>
            <div class="jcell right_m">
              <div class="input-group"> <span class="input-group-addon">应收</span>
                <input type="text" id="in_totalfee" value="{php echo $_GPC['fee'] ? $_GPC['fee'] : '0'}" maxlength="8" class="form-control" readonly/>
                <span class="input-group-addon">元</span> </div>
              <div class="input-group"> <span class="input-group-addon">折扣</span>
                <input type="text" id="in_coupon" value="1.00" maxlength="8" class="form-control" readonly/>
                <span class="input-group-addon">折</span>
              </div>
              <div class="input-group"> <span class="input-group-addon">优惠</span>
                <input type="text" id="in_couponfee" value="0" maxlength="8" class="form-control" readonly/>
                <span class="input-group-addon">元</span> </div>
              <div class="input-group"> <span class="input-group-addon">合计</span>
                <input type="text" id="in_sumfee" value="0" maxlength="8" class="form-control" readonly/>
                <span class="input-group-addon">元</span> </div>
              <div class="input-group"> <span class="input-group-addon">实收</span>
                <input type="text" id="in_paidfee" value="0" style="color:#F00" onFocus="this.select();" maxlength="8" class="form-control" readonly/>
                <span class="input-group-addon">元</span> </div>
              <div class="input-group"> <span class="input-group-addon">找零</span>
                <input type="text" id="in_change" value="0" maxlength="8" class="form-control" readonly />
                <span class="input-group-addon">元</span> </div>
              <ul class="right_btngroup">
               
              </ul>
              <ul class="right_btngroup">
                {if $shop['cash_status']}
                <li id="btn_cash" class="paybtn disabled">
                  <div><i class="fa fa-money fa-2x"></i></div>
                  现金 </li>
                <li id="btn_bankcard" class="paybtn disabled">
                  <div><i class="fa fa-credit-card fa-2x"></i></div>
                  银行卡 </li>
                {/if}
                 <li id="btn_start" class="btn_start">
                  <div><i class="fa fa-plus-square fa-2x"></i></div>
                  开始收款 </li>
                
              </ul>
              <ul class="right_btngroup">
                {if $shop['member_status']}
                <li id="btn_membercash"  class="paybtn disabled">
                  <div><i class="fa fa-sign-out fa-2x"></i></div>
                  余额支付 </li>
                {/if}
                
                {if $shop['ali_status'] || $shop['wechat_status']}
                <li id="btn_weichat"  class="paybtn disabled">
                  <div><i class="fa fa-weixin fa-2x"></i></div>
                  {if $shop['wechat_status']}微信{/if}
                  {if $shop['ali_status']}支付宝{/if} </li>
                {/if}
                <li id="btn_sure" class="btnsure disabled">
                  <div><i class="fa fa-yen fa-2x"></i></div>
                  确认收款 </li>
              </ul>
            </div>
            <div class="jcell right_r" >
              <div id="coupon_list">
              	<h2>优惠</h2>
                <ul>
                  {loop $marketList $row}
                  <li onclick="changeDiscount(this)" cost="{php echo sprintf('%.2f',($row['condition_fee']*0.01))}" discount="{$row['favorable']}" discounttype="1" memberid="{$row['condition_member']}" memberstr="{$row['memberstr']}" marketid="{$row['id']}"><span class="pull-right">0</span><b><i class="fa fa-square-o"></i></b> {$row['title']}</li>
                  {/loop}
                </ul>
              </div>
              <div id="print_show">
                <div>流水号：</div>
                <div class="doct">收银员：{$user['useracount']}</div>
                <div class="print_total"><span>￥0.00</span>应收金额：</div>
                <div class="print_coupon"><span>1.00</span>折扣：</div>
                <div class="print_couponfee doct"><span>￥0.00</span>优惠：</div>
                <div class="doct print_sumfee red"><span>￥0.00</span>合计：</div>
                <div class="print_paid"><span>￥0.00</span>实收：</div>
                <div class="doct print_change"><span>￥0.00</span>找零：</div>
              </div>
            </div>
          </div>
        </div>
        {/if} 
      </div>
      <!---->
      <div class="main_window hiden" id="win_orders">
        <div class="panel panel-default">
          <div class="panel-body form-inline">
            <div class="input-group"> <span class="input-group-addon">搜索</span>
              <input type="text" placeholder="请输入单号/会员卡号" id="keyword" class="form-control"/>
              <span class="input-group-addon" onclick="$('#keyword').JKeyboard({'type':1,'tips':'请输入单号/会员卡号'});"><i class="fa fa-keyboard-o"></i></span> </div>
            <div class="input-group"> <span class="input-group-addon">时间</span>
              <input class="form-control" id="datestart" type="text" style="width:120px" placeholder="请选择时间" readonly  onClick="jeDate({dateCell:'#datestart',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
              <span class="input-group-addon">至</span>
              <input class="datainp form-control" id="dateend" style="width:120px" type="text" placeholder="请选择时间" readonly onClick="jeDate({dateCell:'#dateend',isTime:false,format:'YYYY-MM-DD'})" value="{php echo date('Y-m-d')}"/>
              <span class="input-group-addon"></span> </div>
            <input type="button" class="btn btn-info" style="line-height:26px;" onClick="history_search()" value="搜索"/>
            {if $user['permission']>1}
            <input type="button" class="btn btn-danger" style="line-height:26px;" onClick="history_explort()" value="导出"/>
            {/if} </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <table class="historybox">
              <thead>
                <tr>
                  <th style="width:100px">订单金额</th>
                  <th style="width:90px">折扣</th>
                  <th style="width:110px;">优惠</th>
                  <th style="width:100px">合计</th>
                  <th style="width:100px">实付</th>
                  <th style="width:100px">结算</th>
                  <th style="width:100px">状态</th>
                  <th style="text-align:right">操作</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
        <div id="history_listbox"></div>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="in_paytype" value=""/>
<input type="hidden" id="in_ispass" value=""/>
<input type="hidden" id="in_paynum" value=""/>
<input type="hidden" id="in_password" value=""/>
<input type="hidden" id="in_membercardno"/>
<div class="modal fade" id="modal_membernew" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_membernew" onSubmit="return false;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"> 新增会员卡
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">卡号</label>
            <div class="col-sm-9">
              <div class="input-group">
                <input type="text" id="newcard_cardno" class="form-control" autocomplete="off"/>
                <span class="input-group-addon" onClick="$('#newcard_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
              <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">姓名</label>
            <div class="col-sm-9">
              <input type="text" id="newcard_realname" class="form-control" autocomplete="off"/>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">电话</label>
            <div class="col-sm-9">
              <div class="input-group">
                <input type="tel" id="newcard_mobile" class="form-control" autocomplete="off"/>
                <span class="input-group-addon" onClick="$('#newcard_mobile').JKeyboard({'type':0,'tips':'请输入电话'});"><i class="fa fa-keyboard-o"></i></span></div>
              <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">密码</label>
            <div class="col-sm-9">
              <input type="password" id="newcard_password" class="form-control" autocomplete="off"/>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">重复密码</label>
            <div class="col-sm-9">
              <input type="password" id="newcard_password2" class="form-control" autocomplete="off"/>
            </div>
            <div class="help-block"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary" id="newcard_submitbtn" onClick="return newcard_submit();">新开卡</button>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="modal fade" id="modal_memberrecharge" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_memberrecharge" onSubmit="return false;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"> 会员卡充值
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">卡号</label>
            <div class="col-sm-9">
              <div class="input-group">
                <input type="text" id="recharge_cardno" class="form-control"/>
                <span class="input-group-addon" onClick="$('#recharge_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
              <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">充值金额</label>
            <div class="col-sm-9">
              <div class="input-group">
                <input type="text" id="recharge_totalfee" class="form-control"/>
                <span class="input-group-addon" onClick="$('#recharge_totalfee').JKeyboard({'type':0,'tips':'请输入充值金额'});"><i class="fa fa-keyboard-o"></i></span></div>
              <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">支付方式</label>
            <div class="col-sm-9 form-inline">
              <input type="hidden" id="recharge_paytype" value="0" class="form-control" />
              <ul class="radio">
                <li class="checked">现金支付</li>
                <li>银行卡</li>
                <li>微信</li>
                <li>支付宝</li>
              </ul>
            </div>
            <div class="help-block"></div>
          </div>
          <div class="form-group" id="recharge_other">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">银行卡后四位</label>
            <div class="col-sm-9">
              <div class="input-group">
                <input type="text" id="recharge_code" class="form-control"/>
                <span class="input-group-addon" onClick="$('#recharge_code').JKeyboard({'type':0});"><i class="fa fa-keyboard-o"></i></span></div>
              <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary" id="newcard_submitbtn" onClick="return recharge_submit();">充值</button>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="modal fade" id="modal_choseprint" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        选择小票默认打印机<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
        <select id="choseprint" class="form-control">
        
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-info" onClick="choosePrinter(2)">确定</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modal_tiecard" tabindex="-1" role="dialog" aria-hidden="true">
  <form method="post" id="form_tiecard_cardno" onSubmit="return false;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        绑定会员卡<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      </div>
      <div class="modal-body">
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">实体卡号</label>
            <div class="col-sm-9">
            	<div class="input-group"><input type="text" id="tiecard_cardno" class="form-control"/><span class="input-group-addon" onClick="$('#tiecard_cardno').JKeyboard({'type':1,'tips':'请输入卡号'});"><i class="fa fa-keyboard-o"></i></span></div>
                <div>&nbsp;</div>
            </div>
            <div class="help-block"></div>
         </div>
         <div class="form-group">
         	<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付码</label>
            <div class="col-sm-9">
            	<input type="text" id="tiecard_code" placeholder="请扫描客户的微信支付码" class="form-control"/>
            </div>
            <div class="help-block"></div>
         </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary" onClick="return tiecard_submit();">新开卡</button>
      </div>
    </div>
  </div>
  </form>
</div>
<iframe id="print_iframe" style="position:absolute; z-index:0; width:1px; height:1px;"></iframe>
<script type="text/javascript">
$(".left_btngroup li").on('click',function(){
	var _num=$(this).index();
	$(this).addClass("active").siblings().removeClass("active");
	$(".main_window").eq(_num).show().siblings().hide();
});
function recheckpay(paytype,id){
	var url="{php echo $this->createMobileUrl('ajax',array('op'=>'checwechatkpay_new'))}";
	if(paytype)url="{php echo $this->createMobileUrl('ajax',array('op'=>'checkalipay_new'))}";
	$.post(url,{"id":id},function(data){
		console.log(data);
		var result=eval("("+data+")");
		if(result.success){
			
		}else{
			swal(result.msg)
		}
	});
}
/*退出登录*/
function logout(){
	swal({   
		title: "确认退出登录？",
		type: "warning",
		showCancelButton: true,
		confirmButtonText: "确定",
		cancelButtonText: "取消",
		}, function(isConfirm){
			if (isConfirm){
				$.post("{php echo $this->createMobileUrl('ajax',array('op'=>'logout'))}","",function(data){
					location.href="{php echo $this->createMobileUrl('index')}";
				});
			}
		}
	);
}
//全局参数
var uniacid="{$_W['uniacid']}";
var siteroot="{$_W['siteroot']}";
var global_printnum=0;
var global_print=parseInt("{$shop['printnum']}");
_colorAry=['6CADD1','DF6C6E','eac841','A0D269','23BAB5'];
var resetArt={};
$(document).ready(function(e) {
    $(".body_mainLeft").height($(document).height()-50);
	for(var i=0;i<5;i++){
		var _num=i+1;
		$('#circle_'+_num).radialIndicator({radius:20,barColor:"#"+_colorAry[i],barWidth:5,initValue:0,roundCorner:true,percentage:true});
	}
	setTimeout("getrecord()",1000);
	restart(0);
});
function restart(num){
	if(num==0){
		resetArt.member=$(".member_infobox").html();
		var inputAry=[];
		$("input").each(function(index, element) {
            inputAry[index]=$(this).val();
        });
		resetArt.input=inputAry;
	}else{
		$(".member_infobox").html(resetArt.member);
		var tmp=resetArt.input;
		for(i in tmp){
			$("input").eq(i).val(tmp[i]);
		}
		$("#coupon_list ul").empty();
		$(".right_btngroup li").removeClass("active");
		$(".right_btngroup li").addClass("disabled");
		$("#btn_newcard,#btn_recharge,#btn_refund,#btn_card,#btn_start").removeClass("disabled");
		$("#btn_start").html('<div><i class="fa fa-plus-square fa-2x"></i></div>开始收款');
		sumCounter();
		setTimeout("getrecord()",3000);
	}
}
function top_menu(){
	if($(".masker").size()==0){
		$("body").append('<div class="masker"></div><div id="top_menu" style="opacity:0;">{if $shop["member_status"]}<div class="row"><div class="col-sm-4"> <a href="#" onClick="tieCard()"><div><p><i class="fa fa-puzzle-piece fa-2x"></i></p>绑定微信会员卡</div></a></div>{/if}<div class="col-sm-4"> <a href="#" onClick="choosePrinter(0)"><div><p><i class="fa fa fa-print fa-2x"></i></p>选择打印机 </div></a></div></div></div>');
	}
	$(".masker").width($(document).width()).height($(document).height());
	$(".masker").one('click',function(){
		$(".masker").remove();
		$("#top_menu").remove();
	});
	var _x=$(".body_top_menu").offset().left;
	var _y=$(".body_top_menu").offset().top+$(".body_top_menu").height();
	$("#top_menu").css({"top":(_y+10),"left":_x});
	$("#top_menu").transition({opacity:1,y:-10});
}
function choosePrinter(obj){
	if(obj==0){
		jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":'',"printtype":6});
	}else if(obj==1){
		$("#modal_choseprint").modal("show");
	}else if(obj==2){
		var printername=$("#choseprint option:selected").text();
		var printerindex=$("#choseprint option:selected").val();
		jetsumpay.setdefaultprinter({"uniacid":uniacid,"siteroot":siteroot,"printername":printername,"printerindex":printerindex});
		$("#modal_choseprint").modal("hide");
	}
}
function tieCard(){
	$('#modal_tiecard').modal("show");
}
function tiecard_submit(){
	var _cardno=$("#tiecard_cardno").val();
	var _code=$("#tiecard_code").val();
	if(_cardno.length<1){
		$("#tiecard_cardno").focus();
		return false;
	}
	if(_code.length<11){
		$("#tiecard_code").focus();
		return false;
	}
	jetsumpay.tieCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"code":_code,
		'success':function(data){
			$('#modal_tiecard').modal("hide");
			swal("绑定成功");
		}
	});
	return false;
}
function sumCounter(){
	var total_price=isNaN(parseFloat($("#in_totalfee").val())) ? 0:parseFloat($("#in_totalfee").val());
	var paidfee=isNaN(parseFloat($("#in_paidfee").val())) ? 0:parseFloat($("#in_paidfee").val());
	var discount_fee=0;
	if($("#coupon_list li").size()>0){
		$("#coupon_list li").each(function(index, element){
            var _dis_type=$(this).attr("discounttype");
			if(_dis_type==1){
				var _discount=$(this).attr("discount");
				var fee=0;
				if(_discount.indexOf("%")>-1){
					_discount=parseFloat(_discount.replace("%",""))*0.01;
					fee=_discount*total_price;
				}else{
					fee=_discount;
				}
				$(this).find("span").text("￥ -"+parseFloat(fee).toFixed(2));
			}else if(_dis_type==2){
				var _discount=parseFloat($(this).attr("discount"));
				var fee=total_price*(1-_discount);
				$(this).find("span").text("￥ -"+parseFloat(fee).toFixed(2));
			}else if(_dis_type==3){
				var _discount=parseFloat($(this).attr("discount"));
				var _distype=parseInt($(this).attr("cardtype"));
				var fee=0;
				if(_distype){
					fee=total_price*(1-_discount);
				}else{
					fee=_discount;
				}
				$(this).find("span").text("￥ -"+parseFloat(fee).toFixed(2));
			}
			if($(this).hasClass("active")){
				discount_fee=parseFloat($(this).find("span").text().replace("￥","").replace("-","").replace(" ",""));
				$("#in_couponfee").val(parseFloat(discount_fee).toFixed(2));
			}
        });
	}
	var sum_fee=total_price-discount_fee;
	$("#in_sumfee").val(parseFloat(sum_fee).toFixed(2));
	var change_fee=parseFloat(paidfee-sum_fee);
	$("#in_change").val(change_fee.toFixed(2));
	//
	$(".print_total span").text("￥"+$("#in_totalfee").val());
	$(".print_coupon span").text($("#in_coupon").val());
	$(".print_couponfee span").text("￥"+$("#in_couponfee").val());
	$(".print_sumfee span").text("￥"+$("#in_sumfee").val());
	$(".print_paid span").text("￥"+$("#in_paidfee").val());
	$(".print_change span").text("￥"+$("#in_change").val());
}
$(".right_btngroup li").on('click',function(){
	if($(this).hasClass("disabled"))return;
	switch($(this).attr("id")){
		case "btn_start":
			if(parseInt($("#in_totalfee").val()*100)>0){
				swal({
					title:"放弃当前订单，开始新的收款？",
					text: "当前订单还没有完成，是否放弃？",
					html:true,
					showCancelButton: true,
					closeOnConfirm: false,
					confirmButtonText: "确认",
					cancelButtonText: "关闭",
					}, function(isConfirm){
					if(isConfirm) {
						location.reload();
					}
				})
			}else{
				payInputBox({"paytype":0,'success':function(num){
					swal.close();
					$("#in_totalfee").val(parseFloat(num).toFixed(2));
					$("#btn_start").html('<div><i class="fa fa-plus-square fa-2x"></i></div>重新开始');
					$("#btn_cash,#btn_bankcard,#btn_sure,#btn_membercash,#btn_weichat,#btn_membercard").removeClass("disabled");
					$("#btn_recharge,#btn_newcard,#btn_refund").addClass("disabled");
					sumCounter();
				}});
			}
		break;
		
		case "btn_membercard":
			payInputBox({"paytype":3,'success':function(num){
				jetsumpay.checkMemberCard({"uniacid":uniacid,"siteroot":siteroot,
					"keyword":num,
					'success':function(data){
						swal.close();
						$("#member_name").text(data.realname);
						if(data.password){
							$("#member_passowrd").html("<span class='label label-danger'>是</span>");
							$("#in_ispass").val(1);
						}else{
							$("#member_passowrd").html("<span class='label label-default'>否</span>");
							$("#in_ispass").val(0);
						}
						$("#member_mobile").text(data.mobile);
						$("#member_no").text(data.cardno ? data.cardno : data.wxcardno);
						$("#member_level").text(data.leveltxt);
						$("#member_credit").text(data.credit);
						$("#member_discount").text(data.mobile);
						$("#member_cash").text(data.cash);
						$("#in_membercardno").val(data['id']);
						if($("#coupon_list li[discounttype='2']").size()>0)$("#coupon_list li[discounttype='2']").remove();
						var temp='<li onclick="changeDiscount(this)" '+(data['password'].length>1 ? "ispass='1'":"")+' discount="'+data['discount']+'" discounttype="2" memberid="'+data['id']+'"><span class="pull-right">0</span><b><i class="fa fa-circle"></i></b> 会员折扣</li>';
						$("#coupon_list ul").append(temp);
						$("#coupon_list li[discounttype='2']").click();
						sumCounter();
					}
				});
			}})
		break;
		case "btn_card":
			payInputBox({"paytype":4,'success':function(cardid){
				swal("请稍后，查询中...");
				jetsumpay.checkCard({"uniacid":uniacid,"siteroot":siteroot,"cardid":cardid,'success':function(cardinfo){
					if(cardinfo["type"]=="discount" || cardinfo["type"]=="cash"){
						if(parseInt($("#in_totalfee").val()*100)==0){
							swal("使用代金券/折扣券时，请先输入应收金额");
							return false;
						}
						var _totalfee=parseFloat($("#txt_orderfee").text());
						var _least_cost=parseInt(cardinfo['least_cost']) ? parseInt(cardinfo['least_cost']) : 0;
						var _discount=parseInt(cardinfo['discount']);
						var cardtype=cardinfo["type"]=="discount" ? 1 : 0;
						var _til=cardinfo["type"]=="discount" ? "折扣券" : "代金券";
						var _txt=cardinfo["type"]=="discount" ? "应付金额打<b class='red'>"+(_discount*0.1)+"</b>折" :"满￥<b class='red'>"+(_least_cost*0.01).toFixed(2)+"</b>元减￥<b class='red'>"+(_discount*0.01).toFixed(2)+"</b>元";
						_txt+="<br>是否使用此卡券？";
						jconfirm({
							"title":_til,
							"text":_txt,
							"success":function(){
								var _til="";
								if(cardinfo["type"]=="discount"){
									_til="折扣券优惠";
								}else{
									_til="代金券优惠";
								}
								$("#coupon_list ul").append('<li onclick="changeDiscount(this)" cost="'+(_least_cost*0.01).toFixed(2)+'" cardtype="'+cardtype+'" discount="'+(_discount*0.01)+'" discounttype="3" discountid="'+cardinfo['code']+'"><span class="pull-right">0</span><b><i class="fa fa-square-o"></i></b> '+_til+'</li>');
								
								sumCounter();
								$("#coupon_list li[discountid='"+cardinfo['code']+"']").click();
							}
						});
					}else{
						swal({
							title: cardinfo['typestr'],
							text: cardinfo['msg'],
							html:true,
							closeOnConfirm: true,
							showCancelButton: true,
							confirmButtonText: "确认使用",
							cancelButtonText: "关闭",
							}, function(isConfirm){
								if(isConfirm){
									jetsumpay.cardConsume({"uniacid":uniacid,"siteroot":siteroot,"cardid":cardinfo['code'],'success':function(data){
										console.log(data);
										jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"ordersn":data['id'],"printtype":1});
									}});
								}
							}
						)
					}
				}});
			}});
		break;
		
		case "btn_cash":
			if(!parseFloat($("#in_totalfee").val())){
				$("#btn_start").click();
				return false;
			}
			payInputBox({"paytype":1,'success':function(num){
				$("#in_paidfee").val(parseFloat(num).toFixed(2));
				$(".paybtn").removeClass("active");
				$("#btn_cash").addClass("active");
				$("#in_paytype").val(2);
				sumCounter();
				$("#btn_sure").click();
			}});
		break;
		case "btn_bankcard":
			if(!parseFloat($("#in_totalfee").val())){
				$("#btn_start").click();
				return false;
			}
			payInputBox({"fee":parseFloat($("#in_totalfee").val()).toFixed(2),"paytype":2,'success':function(num){
				$(".paybtn").removeClass("active");
				$("#btn_bankcard").addClass("active");
				$("#in_paidfee").val(parseFloat($("#in_totalfee").val()));
				sumCounter();
				$("#in_paytype").val(3);
				$("#btn_sure").click();
			}});
		break;
		case "btn_weichat":
			if(!parseFloat($("#in_totalfee").val())){
				$("#btn_start").click();
				return false;
			}
			payInputBox({"fee":parseFloat($("#in_sumfee").val()).toFixed(2),"paytype":5,'success':function(num){
				$(".paybtn").removeClass("active");
				$("#btn_weichat").addClass("active");
				$("#in_paidfee").val(parseFloat($("#in_totalfee").val()));
				$("#in_paynum").val(num);
				$("#in_paytype").val(0);
				if(num.substr(0,1)==2)$("#in_paytype").val(1);
				sumCounter();
				$("#btn_sure").click();
			}});
		break;
		case "btn_membercash":
			var memberno=parseFloat($('#in_membercardno').val());
			if(!memberno){
				$("#btn_membercard").click();
				return false;
			}
			var membercash=parseFloat($('#member_cash').text());
			var sumfee=parseFloat($('#in_sumfee').val());
			if(sumfee>membercash || membercash==0){
				swal("当前余额不足，请先充值");
				return false;
			}
			$(".paybtn").removeClass("active");
			$("#btn_membercash").addClass("active");
			$("#in_paytype").val(4);
			$("#in_paidfee").val(parseFloat($("#in_totalfee").val()));
			$("#in_change").val(0);
			
			$("#btn_sure").click();
		break;
		case "btn_sure":
			if(parseFloat($("#in_totalfee").val())*100==0){
				$("#btn_start").click();
				return;
			}
			if(parseFloat($("#in_paidfee").val())*100==0){
				swal("请选择支付方式");
				return;
			}
			if(parseFloat($("#in_change").val())*100<0){
				swal("付款金额不足");
				return;
			}
			if($("#in_paytype").val()==4 && $("#in_ispass").val() && !$("#in_password").val()){
				payInputBox({"paytype":9,"pass":1,"success":function(num){
					$("#in_password").val(num);
					$("#btn_sure").click();
				}});
				return false;
			}
			swal({
				title: "确认支付?<img src='../addons/j_money/template/img/bank.png' onload='getpro()'/>",
				type: "input",
				html:true,
				showCancelButton: true,
				confirmButtonText: "确定",
				cancelButtonText: "取消",
				inputPlaceholder: "请输入备注，可不填"
				}, function(isConfirm){
					remark=$(".showSweetAlert input[type='text']").val();
					$(".goodlist").remove();
					if(isConfirm.toString()!="false"){
						swal({title:"系统处理中",showConfirmButton:false});
						var discounttype=parseInt($("#coupon_list li.active").attr("discounttype"));
						var cardid=$("#coupon_list li.active").attr("discountid") ? $("#coupon_list li.active").attr("discountid") :"";
						var marketid=parseInt($("#coupon_list li.active").attr("marketid")) ? parseInt($("#coupon_list li.active").attr("marketid")) : 0;
						var discount=1;
						if(discounttype==2){
							discount=$("#coupon_list li.active").attr("discount");
						}else if(discounttype==3){
							if(parseInt($("#coupon_list li.active").attr("cardtype"))){
								discount=$("#coupon_list li.active").attr("discount");
							}
						}
						jetsumpay.payAll({"uniacid":uniacid,"siteroot":siteroot,
							"paytype":$("#in_paytype").val(),
							"orderfee":$("#in_totalfee").val(),
							"couponfee":$("#in_couponfee").val(),
							"discount":discount,
							"marketid":marketid,
							"totalfee":$("#in_sumfee").val(),
							"paidfee":$("#in_paidfee").val(),
							"change":$("#in_change").val(),
							"cardid":cardid,
							"memberno":$("#in_membercardno").val(),
							"password":$("#in_password").val(),
							"code":$("#in_paynum").val(),
							"discounttype":discounttype,
							"remark":remark,
							"success":function(data){
								restart(1);
								jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":data});
								jetsumpay.paySuccess({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":data,"success":function(ordernum){
									swal({title:"收款成功",showLoaderOnConfirm: true});
								}});
							}
						});
					}
				}
			);
		break;
		
		case "btn_newcard":
			$('#modal_membernew').modal("show").on('shown.bs.modal', function (e) {});
		break;
		case "btn_recharge":
			$('#modal_memberrecharge').modal("show").on('shown.bs.modal', function (e) {
				$("#recharge_other").hide();
				$("#form_memberrecharge .radio li").bind('click',function(){
					if($(this).hasClass('checked'))return;
					$(this).siblings().removeClass('checked').end().addClass('checked');
					switch($(this).index()){
						case 0:
							$("#recharge_other label").text("");
							$("#recharge_other").hide();
						break;
						case 1:
							$("#recharge_other label").text("银行卡后四位数字");
							$("#recharge_other").show();
							$("#recharge_code").focus();
						break;
						case 2:
							$("#recharge_other label").text("微信付款码");
							$("#recharge_other").show();
							$("#recharge_code").focus();
						break;
						case 3:
							$("#recharge_other label").text("支付宝付款码");
							$("#recharge_other").show();
							$("#recharge_code").focus();
						break;
					}
					$('#recharge_code').val('');
					$('#recharge_paytype').val($(this).index());
				})
			}).on('hide.bs.modal', function (e) {
				$("#recharge_other").hide();
				$("#form_memberrecharge .radio li").unbind('click');
				$('#recharge_cardno,#recharge_totalfee,#recharge_code').val('');
				$("#form_memberrecharge .radio li").removeClass("checked").eq(0).addClass("checked");
				$('#recharge_paytype').val('0');
			});
		break;
		
		case "btn_refund":
			payInputBox({"paytype":8,'success':function(num){
				var ordersn=num;
				jetsumpay.getView({"uniacid":uniacid,"siteroot":siteroot,"keyword":ordersn,"success":function(data){
					var remainFee=parseInt(data['total_fee'])-parseInt(data['refund_fee']);
					swal({
						title: "订单付款金额￥"+(parseInt(data['total_fee'])*0.01).toFixed(2)+"元<img src='../addons/j_money/template/img/bank.png' onload='showCounter()'/>",
						text: "已退款<b class='red'>"+(parseInt(data['refund_fee'])*0.01).toFixed(2)+"</b>,本次退款还可退款￥<b class='red'>"+(remainFee*0.01).toFixed(2)+"</b>元",
						type: "input",
						html:true,
						closeOnConfirm: false,
						showCancelButton: true,
						confirmButtonText: "退款",
						cancelButtonText: "关闭",
						inputPlaceholder:"请输入退款金额" 
						}, function(inputValue){
							$('.sweet-counter-box').addClass("hide");
							if (inputValue === false)return false;
							if (inputValue === "") {
								swal.showInputError("请输入退款金额");
								$('.sweet-counter-box').removeClass("hide");
								return false
							}
							var fee=parseFloat(inputValue)*100;
							if(fee>remainFee){
								swal.showInputError("退款金额不能大于"+(remainFee*0.01).toFixed(2)+"元");
								$('.sweet-counter-box').removeClass("hide");
								return false
							}
							jetsumpay.refund({"uniacid":uniacid,"siteroot":siteroot,"ordersn":ordersn,"fee":inputValue,"success":function(data2){
								swal("退款成功！");
								jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn,"printtype":4});
							}})
					})
				}});
			}});
		break;
		
	}
});
function changeDiscount(obj){
	var discounttype=parseInt($(obj).attr("discounttype"));
	if(discounttype==3 && !parseInt($(obj).attr("cardtype"))){
		var _leastcost=parseFloat($(obj).attr("cost"));
		var _totalfee=parseFloat($("#order_fee").text());
		if(_totalfee<_leastcost){
			swal("该卡券必须满￥"+_leastcost+"元方可使用");
			return false;
		}
	}else if(discounttype==1){
		var _leastcost=parseFloat($(obj).attr("cost"));
		var _totalfee=parseFloat($("#order_fee").text());
		if(_totalfee<_leastcost){
			swal("必须满￥"+_leastcost+"元方可使用");
			return false;
		}
		var _memberid=$(obj).attr("memberid");
		if(_memberid){
			var _memberstr=$(obj).attr("memberstr");
			if(!$("#in_membercardno").val()){
				swal("必须是"+_memberstr+"方可使用");
				return false;
			}
			if(_memberstr.indexOf($(".memberinfo_box span:eq(1)").text())==-1){
				swal("必须是"+_memberstr+"方可使用");
				return false;
			}
		}
	}
	$(obj).addClass('active').siblings().removeClass("active");
	$(obj).find("b").html('<i class="fa fa-check-square"></i>');
	$(obj).siblings().find("b").html('<i class="fa fa-square-o"></i>');
	sumCounter();
}
function newcard_submit(){
	var _cardno=$("#newcard_cardno").val();
	var _realname=$("#newcard_realname").val();
	var _mobile=$("#newcard_mobile").val();
	var _password=$("#newcard_password").val();
	var _password2=$("#newcard_password2").val();
	if(_cardno.length<5){
		swal('请填写卡号');
		return false;
	}
	if(_mobile.length!=11){
		swal('请正确填写手机号码，否则将无法绑定会员卡');
		return false;
	}
	if(_password!=_password2){
		swal("两次输入的密码不一致");
		return false;
	}
	jetsumpay.newCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"realname":_realname,
		"mobile":_mobile,
		"password":_password,
		'success':function(data){
			$('#modal_membernew').modal("hide").on('hidden.bs.modal',function (e) {
				swal({   
					title: "开卡成功，是否进行充值？",
					showCancelButton: true,
					confirmButtonText: "确定",
					cancelButtonText: "取消",
					}, function(isConfirm){
						if (isConfirm){
							$("#recharge_cardno").val(_cardno)
							$("#btn_recharge").click();
						}
					}
				);
			});
			
		}
	});
	return false;
}
function recharge_submit(){
	var _cardno=$("#recharge_cardno").val();
	var _fee=$("#recharge_totalfee").val();
	var _paytype=parseInt($("#recharge_paytype").val());
	var _code=$("#recharge_code").val();
	if(_cardno.length<5){
		swal('请填写卡号');
		return false;
	}
	if(parseInt(_fee)<1){
		swal('充值金额必须为大于1的整数');
		return false;
	}
	if(_paytype>0 && _code.length<1){
		swal("请输入相关内容");
		return false;
	}
	jetsumpay.rechargeCard({"uniacid":uniacid,"siteroot":siteroot,
		"cardno":_cardno,
		"fee":_fee,
		"paytype":_paytype,
		"code":_code,
		'success':function(data){
			var result=eval("("+data+")");
			jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"printtype":2,"ordersn":result.ordersn});
			$('#modal_memberrecharge').modal("hide").on('hidden.bs.modal',function (e) {
				swal({
					title:"充值成功￥"+_fee+"元",
					text:"账户余额：￥<b class='red'>"+(parseInt(result.item.cash)*0.01).toFixed(2)+"</b>元",
					html:true,
				});
			});
		}
	});
	return false;
}
function testPrint(){
	swal("如果不能打印，请退出重新登录");
	jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"printtype":5});
}
function getpro(){
	jetsumpay.getGoods({"uniacid":uniacid,"siteroot":siteroot,"success":function(data){
		var temp='';
		for(i in data){
			temp+='<li onclick="choseGoods(\''+data[i].title+'\')">'+data[i].title+'</li>';
		}
		$(".showSweetAlert fieldset").append("<div class='goodlist'><ul>"+temp+"</ul></div>");
		$(".showSweetAlert").css("margin-top",-230);
	}});
}
function choseGoods(txt){
	var _v=$(".showSweetAlert input").val();
	$(".showSweetAlert input").val(_v+txt);
}
</script> 
<!--page2--> 
<script>
function history_search(){
	var _keyword=$('#keyword').val();
	var _ds=parseInt($('#datestart').val().split("-").join(""));
	var _de=parseInt($('#dateend').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart').val();
	_de=$('#dateend').val();
	jetsumpay.getOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'success':function(data){
		$("#history_listbox").html(data);
		seachcardfrom();	
	}});
}
function history_page(num){
	var _keyword=$('#keyword').val();
	var _ds=$('#datestart').val();
	var _de=$('#dateend').val();
	var _page=$("#history_pageindex").val();
	if(parseInt(num)){
		_page++;
	}else{
		_page--;
	}
	jetsumpay.getOrder({"uniacid":uniacid,"siteroot":siteroot,"keyword":_keyword,'ds':_ds,'de':_de,'page':_page,'success':function(data){
		$("#history_listbox").html(data);
		seachcardfrom();
	}});
}
function seachcardfrom(){
	var ids=[];
	$(".member_idary").each(function(index, element) {
		ids.push($(this).text());
	});
	if(ids.length==0)return;
	jetsumpay.seachcardfromid({"uniacid":uniacid,"siteroot":siteroot,"id":ids,'success':function(items){
		$(".member_idary").each(function(index, element) {
			var _txt=$(this).text();
			var cardno=items[_txt]['cardno'] ? items[_txt]['cardno'] :items[_txt]['wxcardno'];
			$(this).text(cardno);
		});
	}});
}
function history_explort(){
	var _keyword=$('#keyword').val();
	var _ds=parseInt($('#datestart').val().split("-").join(""));
	var _de=parseInt($('#dateend').val().split("-").join(""));
	if(_de<_ds){
		swal("结束时间不能小于开始时间");
		return;
	}
	_ds=$('#datestart').val();
	_de=$('#dateend').val();
	var url='{php echo $this->createMobileUrl("explode")}&op=3&keyword='+_keyword+'&ds='+_ds+'&de='+_de;
	window.open(url);
}
function historyOrder_print(ordersn){
	jconfirm({"title":"是否打印订单？","success":function(){
		jetsumpay.printOrder({"uniacid":uniacid,"siteroot":siteroot,"out_trade_no":ordersn});
	}});
}
<!--page3-->
</script> 
{/if} 
