<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>微信扫描确认</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="js/common.js"></script>
		<style>
			.mui-content-padded {
				margin-top: 25px;
			}
			.mui-btn {
				padding: 10px;
			}
			.mui-content div{
				width:90%;
				margin: 20px 5%;
			}
			.mui-content img{
				width: 100%;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">微信扫描确认</h1>
		</header>
		<div class="mui-content">
			<div id="qr_pic">
				
			</div>
		</div>

		<div class="mui-content-padded">
			<button id='barcode' class="mui-btn mui-btn-block mui-btn-primary">取消</button>
		</div>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			(function($, doc) {
				$.init({
					statusBarBackground: '#f7f7f7'
				});
				$.plusReady(function() {
					var baseUrl = plus.storage.getItem("baseUrl");
					var postUrl = baseUrl + "&c=entry&m=j_money&do=ajax&op=getRefoundConfirmUrl";
					console.log(postUrl);					
					var interval = null;
					var qrcode = "";
					$.ajax({
						type:"post",
						url:postUrl,
						data:{qrcode:qrcode},
						async:true,
						dataType:"text",
						success:function(data){
							console.log(data)
							var liantu = "http://qr.liantu.com/api.php?text=";
							var qr_url = liantu + data;
							
							doc.getElementById("qr_pic").innerHTML = "<img src=\""+qr_url+"\" alt=\"微信二维码\">";
							checkLogin();
							function checkLogin(){
								var postUrl = baseUrl + "&c=entry&m=j_money&do=ajax&op=checkRefoudConfirm";
								$.ajax({
									type:"post",
									url:postUrl,
									async:true,
									dataType:"json",
									success:function(data){
										console.log(JSON.stringify(data));
										if(data.success == false){
											if(data.reload == false){
												interval = window.setTimeout(function(){
													checkLogin();
												},3000);
											}else{
												window.clearTimeout(interval);
												plus.nativeUI.alert( "二维码已过期!", function(){
													clicked('pay_record.html',false,false);
												}, "提示", "确定" );
												
											}
										}else{
											window.clearTimeout(interval);
											var refund_log_id = data.refund_log_id;
											localStorage.setItem( "refund_log_id", refund_log_id);
											clicked("scan_refund_by_fuyou.html",false,false);
											return;
										}
									}
								})
							}
						}
					})
					
					mui(".mui-content-padded").on("click","#barcode",function(){
						window.clearTimeout(interval);
						clicked('barcode_pay.html',false,false);
					});
					
				})
			}(mui, document));
		</script>
	</body>

</html>