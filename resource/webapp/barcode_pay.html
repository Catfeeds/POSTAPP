<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head design-width="540">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
	<!-- 优先使用 IE 最新版本和 Chrome -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<meta name="HandheldFriendly" content="true"/>
	<meta name="MobileOptimized" content="320"/>
	<!-- 启用360浏览器的极速模式(webkit) -->
	<!-- <link rel="shortcut icon" type="image/ico" href="/favicon.ico"/> -->
	<!-- 添加 favicon icon -->
	<meta name="renderer" content="webkit">
	<title>移动支付</title>
	<link rel="stylesheet" href="css/public.css?ver=1" />
	<script src="js/font-size.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
	<script src="js/zepto.js"></script>
	<script src="js/print.js"></script>

	<script type="text/javascript">

		
		document.addEventListener('plusready',plusReady,false);

		function plusReady(){
			var first = null;
			plus.key.addEventListener('backbutton',function(){
				console.log('backbutton');
				if (!first) {
					first = new Date().getTime();
					plus.nativeUI.toast('再按一次退出应用');
					setTimeout(function() {
						first = null;
					}, 3000);
					
				} else {
					if (new Date().getTime() - first < 3000) {
						plus.runtime.quit();
					}
				}
			},false);
			var shop = localStorage.getItem("shop");
			$(".logo")[0].innerHTML = shop;
			
			$("#submitBtn").on("click",function(){
				var pay_type = $("#pay_type").val();
				var total = document.getElementById('total-text').innerHTML;
				console.log(total);
				if(total <= 0){
					plus.nativeUI.alert('请输入金额');
					return false;
				}
				plus.storage.removeItem("pay_total");
				plus.storage.setItem("pay_total",total);
				if(pay_type == 2){
					clicked('scan_payall_by_fuyou.html',false,false);
					return;
				}else{
//					console.log(PrefixInteger(total*100));
					cardPay(total);
					return;
				}
			});
		}
		
		function cardPay(total){
			var main = null;
			var Intent = plus.android.importClass("android.content.Intent");
			var ComponentName = plus.android.importClass("android.content.ComponentName");
			var intent = new Intent();
			var flag = false;
			var total_fee = PrefixInteger(total*100);
			var account = localStorage.getItem("account");
			var audioPlay = localStorage.getItem(account+"audioPlay");
			intent.setComponent(new ComponentName("com.fuyousf.android.fuious","com.fuyousf.android.fuious.MainActivity"));
			intent.putExtra("transName", "消费");
			intent.putExtra("amount", total_fee);
//			intent.putExtra("orderNumber", "123435346");
			intent.putExtra("version", "1.0.7");
			main = plus.android.runtimeMainActivity();
	        main.onActivityResult = function(requestCode, resultCode, data) {
	        	if(flag){
	        		return false;
	        	}
	        	flag = true;
	        	console.log(flag);
	        	console.log(resultCode);
	        	plus.android.importClass(data);
		        var bundle       = data.getExtras();
		        plus.android.importClass(bundle);
	        	if(resultCode == -1){
		        	var amount       = bundle.getString("amount");
		        	var traceNo      = bundle.getString("traceNo");
		        	var batchNo      = bundle.getString("batchNo");
		        	var referenceNo  = bundle.getString("referenceNo");
		        	var cardNo       = bundle.getString("cardNo");
		        	var type         = bundle.getString("type");
		        	var issue        = bundle.getString("issue");
		        	var date         = bundle.getString("date");
		        	var time         = bundle.getString("time");
		        	var orderNumber  = bundle.getString("orderNumber");
		        	var terminalId   = bundle.getString("terminalId");
		        	var merchantId   = bundle.getString("merchantId");
		        	var merchantName = bundle.getString("merchantName");
					console.log("traceNo = " + traceNo);	
					console.log("cardNo = " + cardNo);
					if(audioPlay == 1){
			    		startPlay('_www/audio/transsucc.mp3');
				    	window.setTimeout(function(){
//						    getToUrl(1);
					    	return false;
						},2000);
			    	}else{
//			    		getToUrl(1);
					    return false;
			    	}
				}else{
					var reason = bundle.getString("reason");
					console.log("reason = " + reason);	
					plus.nativeUI.alert(reason);
					if(audioPlay == 1){
				    	startPlay('_www/audio/transfail.mp3');
				    }
				}
				
	        };
	        main.startActivityForResult(intent, 0);
		}
		
		function PrefixInteger(num) {
			var length = 12;
			return (Array(length).join('0') + num).slice(-length);
		}
		
		function startPlay(url){
			var p = plus.audio.createPlayer(url);
			p.play(function(){
				p.stop();
			}, function(e){
				plus.nativeUI.alert('播放音频文件失败');
			});
		}

		function goBarcodePay(){
			var pay_type = $("#pay_type").val();
			var total = document.getElementById('total-text').innerHTML;
			console.log(total);
			if(total <= 0){
				plus.nativeUI.alert('请输入金额');
				return false;
			}
			plus.storage.removeItem("pay_total");
			plus.storage.setItem("pay_total",total);
			if(pay_type == 2){
				clicked('scan_payall_by_fuyou.html',false,false);
//				clicked("barcode_scan_payall.html",false,false);
				return;
			}else{
				clicked('card_pay_info.html',false,false);
				return;
			}
			
		}
		
		function changePayType(type){

			$("#pay_type").val(type);
			if(type == 1){
				$(".mobile").addClass("active");
				$(".union").removeClass("active");
				$(".amount-collected .brand img").attr("src","img/hico4.png");
			}else{
				$(".union").addClass("active");
				$(".mobile").removeClass("active");
				$(".amount-collected .brand img").attr("src","img/hico5.png");
			}
		}
		
	</script>
</head>
<body class="bgf0f0f0">
	<header class="header">
		<div class="left-nav vv" onclick="clicked('pay_record.html',false,false)">
			<a href="#">记录</a>
		</div>
		<!--<div class="logo"><a href="#"><img src="img/hico3.png" alt=""></a></div>-->
		<div class="logo" style="font-size: .26rem;color: #FFF;font-weight: 600;">收银台</div>
		<div class="right-nav set" style="height: 0.3rem;width: 0.3rem;" onclick="clicked('setting.html',false,false)">
			<a href="#" style="height: 0.3rem;"></a>
		</div>
		
	</header>
	<main class="main">
		<div class="payment-menthod">
			<div class="union pay active" onclick="changePayType(1);">
				<div class="pic"><img src="img/hico4.png" alt=""></div>
				<div class="text">刷卡支付</div>
			</div>
			<div class="mobile pay" onclick="changePayType(2);">
				<div class="pic"><img src="img/hico5.png" alt=""></div>
				<div class="text">移动支付</div>
			</div>
		</div>
		<input type="hidden" name="pay_type" id="pay_type" value="2" />
		<div class="amount-collected">
			<div class="row title">
				<div class="brand">
					<img src="img/hico5.png" alt="">
				</div>
				<div class="text">输入收款金额：</div>
			</div>
			<div class="row">
				<div class="money" data-before="￥"><span class="text">0.00</span><span  class="cursor"></span></div>
			</div>
			<div class="row" style="display: none;">
				<div class="total">
					<div class="text">总金额:</div>
					<div class="text">￥<span class="total-text" id="total-text">0.00</span></div>
				</div>
			</div>
		</div>
		<div class="input-control normal pc">
			<table>
				<tr>
					<td width="100">1</td>
					<td width="100">2</td>
					<td width="100">3</td>
					<td width="100" class="bgff7f7f back"><img src="img/hico10.png" alt=""></td>
				</tr>
				<tr>
					<td>4</td>
					<td>5</td>
					<td>6</td>
					<td rowspan="3" class="bg3099ff enter" id="submitBtn">
						确认<br>
						收款
					</td>
				</tr>
				<tr>
					<td>7</td>
					<td>8</td>
					<td>9</td>
				</tr>
				<tr>
					<td>00</td>
					<td>0</td>
					<td class="number">.</td>
				</tr>
			</table>
		</div>
	</main>
	<div class="footer-none"></div>
	<footer class="footer footer-nav pc">
		<a href="#" onclick="clicked('member.html',false,false)" class="vip"><div class="pic"></div><div class="text">会员</div></a>
		<a href="#" class="center money active"><div class="pic"></div><div class="wrap poa"><div class="pic"></div></div><div class="text">收款</div></a>
		<a href="#" onclick="clicked('pay_record.html',false,false)" class="set hhh"><div class="pic"></div><div class="text">记录</div></a>
	</footer>
	
	<script src="js/event.js"></script>
	<script src="js/touch.js"></script>
	<script src="js/js.js"></script>
	<script type="text/javascript" src="js/immersed.js" ></script>
</body>
</html>

